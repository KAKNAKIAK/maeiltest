<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ê²¬ì ì„œ_0526_1</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .custom-orange { color: #000; }
        .bg-custom-orange { background-color: #e1e1e1; color: #000; }
        .border-custom-orange { border-color: #ff5a00; }
        .custom-green { color: #66bb6a; }
        .bg-custom-green { background-color: #66bb6a; }
        .border-custom-green { border-color: #66bb6a; }A
        @media print { body { width: 100%; margin: 0; padding: 0; } }
        .mb-8 { margin-bottom: 1rem; }
        .w-2\/10 { width: 20%; }
        .w-3\/10 { width: 34%; }
        .w-4\/10 { width: 40%; }

        .quote-group-section {
            border-width: 2px;
            border-style: solid;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: relative;
            padding-top: 4rem;
            /* border-color will be set by JS */
        }

        .group-action-buttons {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }

        .group-action-buttons button {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            line-height: 1;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        .copy-quote-group-btn { background-color: #ffc107; color: #212529 !important; }
        .copy-quote-group-btn:hover { background-color: #e0a800; }
        .delete-quote-group-btn { background-color: #dc3545; }
        .delete-quote-group-btn:hover { background-color: #c82333; }

        .dynamic-section {
            border: 1px dashed #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            background-color: #fdfdfd;
            position: relative;
        }
        .delete-dynamic-section-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            line-height: 1;
            z-index: 10;
            color: #ef4444;
        }
        .delete-dynamic-section-btn:hover {
            color: #dc2626;
        }

        [contenteditable][placeholder]:empty:before {
            content: attr(placeholder);
            color: #a0aec0;
            pointer-events: none;
            display: block;
        }

        .group-title-input {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .preview-toggle-icon {
            margin-left: 10px;
            font-size: 0.9em;
            color: #555;
        }

        /* --- ìƒì„¸ ì¼ì •í‘œ UI ìŠ¤íƒ€ì¼ --- */
        .itinerary-planner-styles .action-button-sm { 
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: white;
        }
        .itinerary-planner-styles .action-button-sm:hover {
            filter: brightness(0.95);
        }
        .itinerary-planner-styles .action-button-sm .fas { 
            width: 14px;
            height: 14px;
            margin-right: 4px;
        }

        .itinerary-planner-styles .day-section {
            margin-bottom: 16px;
            border: 1px solid #E0E0E0;
            border-radius: 0.375rem;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .itinerary-planner-styles .day-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #EEE;
            background-color: #fdfdfd;
            border-radius: 6px 6px 0 0;
        }
        .itinerary-planner-styles .day-header-main {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
        }
        .itinerary-planner-styles .day-header-title {
            font-size: 18px;
            font-weight: 600;
        }
        .itinerary-planner-styles .date-edit-input { 
            font-size: 16px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 220px; /* Placeholderì— ë§ê²Œ ì¡°ê¸ˆ ë” ë„“í˜ */
        }
        .itinerary-planner-styles .day-header-controls {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .itinerary-planner-styles .icon-button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        .itinerary-planner-styles .icon-button:hover {
            background-color: #e0e0e0;
        }
        .itinerary-planner-styles .icon-button .fas {
            font-size: 1rem;
        }
         .itinerary-planner-styles .icon-button.delete-detailed-day-button .fas { /* ìƒì„¸ì¼ì •ì˜ ë‚ ì§œ ì‚­ì œ ë²„íŠ¼ */
            color: #ef4444;
        }
        .itinerary-planner-styles .icon-button.delete-detailed-day-button:hover .fas {
            color: #dc2626;
        }
        .itinerary-planner-styles .day-content-wrapper {
            padding: 0 8px 8px 8px;
        }
        .itinerary-planner-styles .activity-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
        }
        .itinerary-planner-styles .activities-list .activity-card:first-child {
            margin-top: 8px;
        }
        .itinerary-planner-styles .card-time-icon-area {
            width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .itinerary-planner-styles .card-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .itinerary-planner-styles .card-time {
            font-size: 14px;
            font-weight: bold;
            min-height: 21px;
        }
        .itinerary-planner-styles .card-details-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .itinerary-planner-styles .card-title {
            font-size: 16px;
            font-weight: bold;
        }
        .itinerary-planner-styles .card-description,
        .itinerary-planner-styles .card-location,
        .itinerary-planner-styles .card-cost,
        .itinerary-planner-styles .card-notes {
            font-size: 14px;
            color: #374151;
        }
        .itinerary-planner-styles .card-image {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 8px;
        }
        .itinerary-planner-styles .card-location a {
            color: #007bff;
            text-decoration: none;
        }
        .itinerary-planner-styles .card-location a:hover {
            text-decoration: underline;
        }
         .itinerary-planner-styles .card-actions-direct {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 0.25rem; 
            margin-left: auto; 
            padding-left: 0.5rem;
        }
        .itinerary-planner-styles .card-actions-direct .icon-button .fas {
            font-size: 0.875rem; 
        }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none; 
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 24px; border-radius: 8px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-content label { display: block; margin-bottom: 4px; font-weight: 500; }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; margin-bottom: 12px; background-color: white; height: 40px;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
        #toast {
            position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white;
            padding: 10px 20px; border-radius: 5px; z-index: 1050; opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #toast.show { opacity: 1; }
        /* --- ëª¨ë°”ì¼ ì¶”ì²œì¼ì •í‘œ UI ìŠ¤íƒ€ì¼ ë --- */

    </style>
</head>
<body class="bg-white p-4">
    <div class="container mx-auto bg-white p-6 shadow-lg rounded-lg" style="max-width: 950px;">
        <header class="mb-6 border-b pb-4 border-gray-200">
            <h1 class="text-3xl font-bold text-center custom-orange">ë‚´ì¼íˆ¬ì–´ ì—¬í–‰ê²¬ì ì„œ</h1>
        </header>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">ê¸°ë³¸ ì •ë³´</h2>
            <div class="bg-gray-50 p-4 rounded">
                <div class="flex flex-wrap gap-4">
                    <div class="w-full sm:w-2/10 mb-4 sm:mb-0">
                        <label class="block text-gray-700 mb-1 text-sm">ê³ ê°ëª…(ë°›ëŠ”ì´)</label>
                        <input type="text" id="customerName" name="custname" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                    <div class="w-full sm:w-4/10 mb-4 sm:mb-0">
                        <label class="block text-gray-700 mb-1 text-sm">ì´ë©”ì¼</label>
                        <input type="email" id="customerEmail" name="custmail" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                    <div class="w-full sm:w-3/10">
                        <label class="block text-gray-700 mb-1 text-sm">ì°¸ì¡°</label>
                        <input type="text" id="custcmail" name="custcmail" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-1 text-sm">ë©”ì¼ì œëª©</label>
                    <input type="text" id="subject" name="subject" value="[ë‚´ì¼íˆ¬ì–´]  ê³ ê°ë‹˜, í–‰ë³µí•œ ì—¬í–‰ì„ ìœ„í•œ ê²¬ì  ì•ˆë‚´ ë©”ì¼ì…ë‹ˆë‹¤." class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-2 text-sm">ì•ˆë‚´ì‚¬í•­ (ë³¸ë¬¸ ì²« ë¶€ë¶„)</label>
                    <textarea id="introText" name="intro" rows="4" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="ì•ˆë…•í•˜ì„¸ìš”! ë‚´ì¼íˆ¬ì–´ì…ë‹ˆë‹¤. ê³ ê°ë‹˜ì˜ ì†Œì¤‘í•œ ì—¬í–‰ì„ í•¨ê»˜ ì¤€ë¹„í•˜ê² ìŠµë‹ˆë‹¤."></textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-1 text-sm">ìƒí’ˆëª… (ê³µí†µ)</label>
                    <input type="text" id="goodnm" name="goodnm" value="" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">ì˜ˆì•½ì ì •ë³´</h2>
            <div class="bg-gray-50 p-4 rounded">
                <textarea id="travelerInfoText" name="traveler_info_text" rows="3" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="ì˜ˆ : 1 HAN/WONHEE MR 2. LEE/SONGYI MS"></textarea>
            </div>
        </section>

        <div id="quoteGroupsContainer" class="mb-8">
            </div>

        <div class="text-center mb-8 py-4 border-t border-b border-gray-200">
            <button type="button" id="addGlobalQuoteGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                <i class="fas fa-plus mr-2"></i>ìƒˆ ê²¬ì  ê·¸ë£¹ ì¶”ê°€
            </button>
        </div>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">ë‹´ë‹¹ì ì •ë³´</h2>
            <div class="bg-gray-50 p-4 rounded">
                <div class="flex flex-wrap gap-4">
                    <div class="w-full sm:w-2/10 mb-4 sm:mb-0"><label class="block text-gray-700 mb-1 text-sm">ë‹´ë‹¹ì</label><input type="text" id="empnm" name="empnm" value="ì„ì°½ìˆœ" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                    <div class="w-full sm:w-4/10 mb-4 sm:mb-0"><label class="block text-gray-700 mb-1 text-sm">ë‹´ë‹¹ìë©”ì¼</label><input type="email" id="empmail" name="empmail" value="fire@naeiltour.co.kr" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                    <div class="w-full sm:w-3/10"><label class="block text-gray-700 mb-1 text-sm">ì—°ë½ì²˜</label><input type="text" id="emptel" name="emptel" value="02-6262-5301" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                </div>
            </div>
        </section>

        <footer class="mt-8 text-center text-gray-500 text-sm border-t pt-4">
            <button type="button" onclick="previewQuote();" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #e1e1e1;font-weight: 700;color: #000;">ë¯¸ë¦¬ë³´ê¸°</button>
            <button type="button" onclick="downloadGeneratedHTML();" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #28a745;font-weight: 700;color: #fff; margin-left: 5px;">HTML íŒŒì¼ë¡œ ì €ì¥</button>
            <input type="file" id="loadQuoteFile" accept=".html" style="display: none;">
            <button type="button" onclick="document.getElementById('loadQuoteFile').click();" style="padding: 5px 10px; font-size: 13px; cursor: pointer; border: 1px solid #ccc; background: #f0ad4e; font-weight: 700; color: #fff; margin-left: 5px;">ê²¬ì  ë¶ˆëŸ¬ì˜¤ê¸° (HTML)</button>
        </footer>
    </div>

    <div id="activityModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">ìƒˆ ì¼ì • ì¶”ê°€</h2>
            <form id="activityForm">
                <input type="hidden" id="currentQuoteGroupIndex">
                <input type="hidden" id="currentDayIndex">
                <input type="hidden" id="currentActivityId">
                <div>
                    <label for="activityTimeInput">ì‹œê°„ (HHMM í˜•ì‹, ì„ íƒ ì‚¬í•­):</label>
                    <input type="text" id="activityTimeInput" placeholder="ì˜ˆ: 1130 ë˜ëŠ” 0900" maxlength="4">
                </div>
                <div>
                    <label for="activityIconSelect">ì•„ì´ì½˜ ì„ íƒ:</label>
                    <select id="activityIconSelect"> </select>
                </div>
                <div>
                    <label for="activityTitle">í™œë™/ì¥ì†Œëª…:</label>
                    <input type="text" id="activityTitle" required placeholder="ì˜ˆ: ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€ ë°©ë¬¸">
                </div>
                <div>
                    <label for="activityDescription">ê°„ë‹¨ ì„¤ëª…/ë©”ëª¨:</label>
                    <textarea id="activityDescription" rows="3" placeholder="ì˜ˆ: ëª¨ë‚˜ë¦¬ì ë° ì£¼ìš” ì‘í’ˆ ê´€ëŒ"></textarea>
                </div>
                <div>
                    <label for="activityLocation">ì£¼ì†Œ/ìœ„ì¹˜ ë§í¬:</label>
                    <input type="url" id="activityLocation" placeholder="ì˜ˆ: https://maps.google.com/... (ì„ íƒ ì‚¬í•­)">
                </div>
                <div>
                    <label for="activityImageUrl">ì´ë¯¸ì§€ URL:</label>
                    <input type="url" id="activityImageUrl" placeholder="ì˜ˆ: https://example.com/image.jpg (ì„ íƒ ì‚¬í•­)">
                </div>
                <div>
                    <label for="activityCost">ë¹„ìš©:</label>
                    <input type="text" id="activityCost" placeholder="ì˜ˆ: â‚¬20 ë˜ëŠ” â‚©25,000 (ì„ íƒ ì‚¬í•­)">
                </div>
                <div>
                    <label for="activityNotes">ê¸°íƒ€ í•„ë“œ (ì˜ˆì•½ë²ˆí˜¸ ë“±):</label>
                    <input type="text" id="activityNotes" placeholder="ì˜ˆ: ì˜ˆì•½ë²ˆí˜¸: 12345 (ì„ íƒ ì‚¬í•­)">
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancelActivityModalButton" class="action-button-sm bg-gray-300 hover:bg-gray-400 text-gray-800">ì·¨ì†Œ</button>
                    <button type="submit" id="saveActivityModalButton" class="action-button-sm bg-green-500 text-white hover:bg-green-600">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast"></div>

    <script>
        // ----- ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” í•¨ìˆ˜ -----
        let quoteGroupCounter = 0; 
        let quoteGroupDataStore = {}; 

        const travelEmojis = [
            { value: "", display: "ì•„ì´ì½˜ ì—†ìŒ" }, { value: "âœˆï¸", display: "âœˆï¸ í•­ê³µ" }, { value: "ğŸ¨", display: "ğŸ¨ ìˆ™ì†Œ" },
            { value: "ğŸ½ï¸", display: "ğŸ½ï¸ ì‹ì‚¬" }, { value: "ğŸ›ï¸", display: "ğŸ›ï¸ ê´€ê´‘(ì‹¤ë‚´)" }, { value: "ğŸï¸", display: "ğŸï¸ ê´€ê´‘(ì•¼ì™¸)" },
            { value: "ğŸš¶", display: "ğŸš¶ ì´ë™(ë„ë³´)" }, { value: "ğŸšŒ", display: "ğŸšŒ ì´ë™(ë²„ìŠ¤)" }, { value: "ğŸš†", display: "ğŸš† ì´ë™(ê¸°ì°¨)" },
            { value: "ğŸš¢", display: "ğŸš¢ ì´ë™(ë°°)" }, { value: "ğŸš•", display: "ğŸš• ì´ë™(íƒì‹œ)" }, { value: "ğŸ›ï¸", display: "ğŸ›ï¸ ì‡¼í•‘" },
            { value: "ğŸ“·", display: "ğŸ“· ì‚¬ì§„ì´¬ì˜" }, { value: "ğŸ—ºï¸", display: "ğŸ—ºï¸ ê³„íš/ì§€ë„" }, { value: "ğŸ“Œ", display: "ğŸ“Œ ì¤‘ìš”ì¥ì†Œ" },
            { value: "â˜•", display: "â˜• ì¹´í˜/íœ´ì‹" }, { value: "ğŸ­", display: "ğŸ­ ê³µì—°/ë¬¸í™”" }, { value: "ğŸ’¼", display: "ğŸ’¼ ì—…ë¬´" },
            { value: "â„¹ï¸", display: "â„¹ï¸ ì •ë³´" }
        ];

        // ----- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ -----
        function generateId() { return 'id_' + Math.random().toString(36).substr(2, 9); }
        function formatDateForDisplay(dateString, dayNumber) { 
            const date = new Date(dateString + "T00:00:00"); 
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            return `DAY ${dayNumber}: ${date.toLocaleDateString('ko-KR', options)}`;
        }
        function formatTimeToHHMM(timeStr) {
            if (timeStr && timeStr.length === 4 && /^\d{4}$/.test(timeStr)) {
                const hours = timeStr.substring(0, 2);
                const minutes = timeStr.substring(2, 4);
                if (parseInt(hours, 10) >= 0 && parseInt(hours, 10) <= 23 &&
                    parseInt(minutes, 10) >= 0 && parseInt(minutes, 10) <= 59) {
                    return `${hours}:${minutes}`;
                }
            }
            return "";
        }
        function dateToYyyyMmDd(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let dayVal = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (dayVal.length < 2) dayVal = '0' + dayVal;
            return [year, month, dayVal].join('-');
        }
        function showToast(message, duration = 3000) {
            const toastElement = document.getElementById('toast');
            if (toastElement) {
                toastElement.textContent = message;
                toastElement.classList.add('show');
                setTimeout(() => {
                    toastElement.classList.remove('show');
                }, duration);
            }
        }

        // ----- ê²¬ì  ê·¸ë£¹ ìƒì„± ë° ê´€ë¦¬ -----
        const quoteGroupBorderColors = ['#4A90E2', '#50E3C2', '#F5A623', '#BD10E0', '#7ED321', '#D0021B', '#417505', '#9013FE'];
        let currentBorderColorIndex = 0;

        function createQuoteGroup(groupIndex, afterElement = null, sourceGroupData = null) {
            const groupId = `quoteGroup_${groupIndex}`;
            const quoteGroupDiv = document.createElement('div');
            quoteGroupDiv.className = 'quote-group-section';
            quoteGroupDiv.id = groupId;
            quoteGroupDiv.dataset.groupIndex = groupIndex;

            let borderColorToApply = sourceGroupData?.borderColor || quoteGroupBorderColors[currentBorderColorIndex];
            quoteGroupDiv.style.borderColor = borderColorToApply;
            if (!sourceGroupData?.borderColor) {
                 currentBorderColorIndex = (currentBorderColorIndex + 1) % quoteGroupBorderColors.length;
            }

            quoteGroupDataStore[groupIndex] = sourceGroupData || {
                groupTitle: "",
                borderColor: borderColorToApply,
                priceSubgroups: [], 
                inclusionExclusion: { includedTextarea: '', excludedTextarea: '' },
                flightSubgroups: [], 
                itinerarySummaryRows: [], 
                detailedItinerary: { 
                    title: "ì—¬í–‰ ì¼ì •í‘œ", 
                    days: []
                }
            };
             if (sourceGroupData && !sourceGroupData.detailedItinerary) {
                quoteGroupDataStore[groupIndex].detailedItinerary = { title: "ì—¬í–‰ ì¼ì •í‘œ", days: [] };
            }
            if (sourceGroupData && !sourceGroupData.flightSubgroups) { 
                quoteGroupDataStore[groupIndex].flightSubgroups = [];
            }
             if (sourceGroupData && !sourceGroupData.priceSubgroups) { 
                quoteGroupDataStore[groupIndex].priceSubgroups = [];
            }
            if (sourceGroupData && !sourceGroupData.itinerarySummaryRows) { 
                quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
            }


            quoteGroupDiv.innerHTML = `
                <div class="group-action-buttons">
                    <button type="button" class="copy-quote-group-btn" title="ì´ ê²¬ì  ê·¸ë£¹ ë³µì‚¬"><i class="fas fa-copy mr-1"></i>ê·¸ë£¹ ë³µì‚¬</button>
                    <button type="button" class="delete-quote-group-btn" title="ì´ ê²¬ì  ê·¸ë£¹ ì‚­ì œ"><i class="fas fa-trash-alt mr-1"></i>ê·¸ë£¹ ì‚­ì œ</button>
                </div>
                <input type="text" name="quote_group_title[${groupIndex}]" class="group-title-input" placeholder="ê²¬ì  ê·¸ë£¹ ì œëª© (ì˜ˆ: 1. ëŒ€í•œí•­ê³µ + ì‹ ë¼ ëª¨ë…¸ê·¸ë¨ ë‹¤ë‚­ ìŠˆí˜ë¦¬ì–´)" value="${quoteGroupDataStore[groupIndex].groupTitle}">
                
                <section class="mb-8 price-section-wrapper">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold bg-custom-orange p-2 rounded" style="flex-grow: 1;">ìš”ê¸ˆ ì•ˆë‚´</h3>
                        <button type="button" class="add-price-subgroup-button bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-xs ml-2" data-group-index="${groupIndex}">
                            <i class="fas fa-plus mr-1"></i> ìš”ê¸ˆ ì†Œê·¸ë£¹ ì¶”ê°€
                        </button>
                    </div>
                    <div id="priceSectionsContainer_${groupIndex}" class="price-sections-container-for-group"></div>
                </section>

                <section class="mb-8 inclusion-exclusion-section-wrapper">
                    <h3 class="text-lg font-semibold mb-4 bg-custom-orange p-2 rounded">í¬í•¨/ë¶ˆí¬í•¨ ì‚¬í•­</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="text-md font-medium mb-2">í¬í•¨</h4>
                            <textarea name="included_items_textarea[${groupIndex}]" rows="5" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="* ìœ ë¥˜í• ì¦ë£Œ, ì œì„¸ê³µê³¼ê¸ˆ í¬í•¨...">${quoteGroupDataStore[groupIndex].inclusionExclusion.includedTextarea}</textarea>
                        </div>
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="text-md font-medium mb-2">ë¶ˆí¬í•¨</h4>
                            <textarea name="excluded_items_textarea[${groupIndex}]" rows="5" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="â— í˜„ì§€ ê°œì¸ ê²½ë¹„...">${quoteGroupDataStore[groupIndex].inclusionExclusion.excludedTextarea}</textarea>
                        </div>
                    </div>
                </section>

                <section class="mb-8 flight-schedule-section-wrapper">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold bg-custom-orange p-2 rounded" style="flex-grow: 1;">í•­ê³µ ìŠ¤ì¼€ì¤„</h3>
                        <button type="button" class="add-flight-subgroup-button bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-xs ml-2" data-group-index="${groupIndex}">
                            <i class="fas fa-plus mr-1"></i> í•­ê³µ ìŠ¤ì¼€ì¤„ ì†Œê·¸ë£¹ ì¶”ê°€
                        </button>
                    </div>
                    <div id="flightScheduleGroupsContainer_${groupIndex}" class="flight-schedule-groups-container-for-group"></div>
                </section>

                <section class="mb-8 itinerary-summary-section-wrapper">
                    <h3 class="text-lg font-semibold mb-4 bg-custom-orange p-2 rounded">ê°„ë‹¨ì¼ì •</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border text-sm">
                            <thead><tr class="bg-gray-100">
                                <th class="border p-2 text-left text-xs" style="width: 8%;">ì¼ìˆ˜</th><th class="border p-2 text-left text-xs">ë‚ ì§œ</th>
                                <th class="border p-2 text-left text-xs">ì¶œë°œì§€</th><th class="border p-2 text-left text-xs">ë„ì°©ì§€</th>
                                <th class="border p-2 text-left text-xs">ìˆ™ë°•</th><th class="border p-2 text-left text-xs">ì´ë™</th>
                                <th class="border p-2 text-left text-xs">ë¹„ê³ </th><th class="border p-2 text-center w-12 text-xs">ì‚­ì œ</th></tr></thead>
                            <tbody id="itineraryTableBody_${groupIndex}" class="itinerary-table-body-for-group"></tbody>
                            <tfoot><tr><td colspan="8" class="border p-2"><button type="button" class="add-itinerary-row-to-group bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs" data-group-index="${groupIndex}"><i class="fas fa-plus mr-1"></i> í–‰ ì¶”ê°€</button></td></tr></tfoot>
                        </table>
                    </div>
                </section>

                <section class="mb-8 itinerary-detail-section-wrapper">
                    <div class="flex justify-between items-center mb-2 bg-custom-orange p-2 rounded-t-md">
                        <h3 class="text-lg font-semibold">ìƒí’ˆì¼ì • ìƒì„¸ (ì¼ì •í‘œ)</h3>
                        <div class="itinerary-planner-styles flex items-center space-x-2">
                             <button type="button" class="action-button-sm" style="background-color: #A78BFA;" title="ë¯¸ë¦¬ë³´ê¸° (ê¸°ëŠ¥ ì—†ìŒ)" data-group-index="${groupIndex}"><i class="fas fa-eye"></i><span class="hidden sm:inline">ë¯¸ë¦¬ë³´ê¸°</span></button>
                             <button type="button" class="action-button-sm" style="background-color: #F97316;" title="HTML íŒŒì¼ë¡œ ì €ì¥ (ê¸°ëŠ¥ ì—†ìŒ)" data-group-index="${groupIndex}"><i class="fas fa-save"></i><span class="hidden sm:inline">HTML ì €ì¥</span></button>
                             <button type="button" class="action-button-sm" style="background-color: #FACC15;" title="HTML íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ëŠ¥ ì—†ìŒ)" data-group-index="${groupIndex}"><i class="fas fa-upload"></i><span class="hidden sm:inline">HTML ë¶ˆëŸ¬ì˜¤ê¸°</span></button>
                             <button type="button" class="action-button-sm" style="background-color: #22C55E;" title="ì—‘ì…€ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ëŠ¥ ì—†ìŒ)" data-group-index="${groupIndex}"><i class="fas fa-file-excel"></i><span class="hidden sm:inline">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</span></button>
                        </div>
                    </div>
                    <div id="detailedItineraryContainer_${groupIndex}" class="itinerary-planner-styles p-4 border border-t-0 border-gray-200 rounded-b-md bg-gray-100" style="min-height: 150px;">
                        <div id="daysContainerStatic_${groupIndex}"></div>
                        <div class="add-day-button-container mt-4 text-center">
                             <button type="button" class="add-detailed-itinerary-day-button action-button-sm bg-indigo-500 text-white hover:bg-indigo-600" data-group-index="${groupIndex}">
                                <i class="fas fa-plus"></i> ìƒˆ ë‚ ì§œ ì¶”ê°€
                            </button>
                        </div>
                    </div>
                </section>
            `;

            const quoteGroupsContainer = document.getElementById('quoteGroupsContainer');
            if (afterElement && afterElement.parentNode === quoteGroupsContainer) {
                quoteGroupsContainer.insertBefore(quoteGroupDiv, afterElement.nextSibling);
            } else {
                quoteGroupsContainer.appendChild(quoteGroupDiv);
            }
            
            initPriceSectionForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].priceSubgroups);
            initFlightScheduleForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].flightSubgroups);
            initInclusionExclusionForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex]); 
            initItinerarySummaryForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].itinerarySummaryRows);
            renderDetailedItineraryForGroup(groupIndex); 

            return quoteGroupDiv;
        }

        // ----- ìƒì„¸ ì¼ì •í‘œ ê´€ë ¨ í•¨ìˆ˜ë“¤ -----
        function renderDetailedItineraryForGroup(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            if (!groupData || !groupData.detailedItinerary) {
                console.error(`Detailed itinerary data not found for group ${groupIndex}`);
                return;
            }
            const container = document.getElementById(`detailedItineraryContainer_${groupIndex}`);
            if (!container) {
                console.error(`Detailed itinerary container not found for group ${groupIndex}`);
                return;
            }

            let daysHost = container.querySelector(`#daysContainerStatic_${groupIndex}`);
            if (!daysHost) { 
                daysHost = document.createElement('div');
                daysHost.id = `daysContainerStatic_${groupIndex}`;
                const addDayButtonContainer = container.querySelector('.add-day-button-container');
                if (addDayButtonContainer) {
                    container.insertBefore(daysHost, addDayButtonContainer);
                } else {
                    container.appendChild(daysHost); 
                }
            }
            daysHost.innerHTML = ''; 

            groupData.detailedItinerary.days.forEach((day, dayIdx) => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                daySection.dataset.dayIndex = dayIdx; 

                let dateDisplayHTML;
                if (day.editingDate) {
                    dateDisplayHTML = `
                        <input type="text" class="date-edit-input itinerary-planner-styles" value="${day.date}" placeholder="YYYY-MM-DD ë˜ëŠ” YYMMDD">
                        <button class="icon-button save-detailed-date-button itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}" title="ë‚ ì§œ ì €ì¥"><i class="fas fa-save"></i></button>
                        <button class="icon-button cancel-detailed-date-edit-button itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}" title="ì·¨ì†Œ"><i class="fas fa-times"></i></button>
                    `;
                } else {
                    dateDisplayHTML = `
                        <h2 class="day-header-title">${formatDateForDisplay(day.date, dayIdx + 1)}</h2>
                        <button class="icon-button edit-detailed-date-button ml-2 itinerary-planner-styles" title="ë‚ ì§œ ìˆ˜ì •" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    `;
                }

                daySection.innerHTML = `
                    <div class="day-header-container">
                        <div class="day-header-main">
                            ${dateDisplayHTML}
                        </div>
                        <div class="day-header-controls">
                            <button class="icon-button save-day-button itinerary-planner-styles" title="ì´ ë‚ ì§œ HTMLë¡œ ì €ì¥ (ê¸°ëŠ¥ ì—†ìŒ)" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-paperclip"></i></button>
                            <button class="icon-button load-day-button itinerary-planner-styles" title="ì´ ë‚ ì§œì— ë®ì–´ì“°ê¸° (ê¸°ëŠ¥ ì—†ìŒ)" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-clipboard"></i></button>
                            <button class="icon-button delete-detailed-day-button itinerary-planner-styles" title="ì´ ë‚ ì§œ ì „ì²´ ì‚­ì œ" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-trash-alt"></i></button>
                            <button class="icon-button toggle-detailed-day-collapse-button itinerary-planner-styles" title="í¼ì¹˜ê¸°/ì ‘ê¸°" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                                <i class="fas ${day.isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="day-content-wrapper ${day.isCollapsed ? 'hidden' : ''}">
                        <div class="activities-list activities-list-group-${groupIndex}-day-${dayIdx} pt-3" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                            </div>
                        <button class="add-activity-to-day-button mt-3 mb-2 action-button-sm bg-teal-500 text-white hover:bg-teal-600 itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                            <i class="fas fa-plus"></i> ì´ ë‚ ì§œì— ìƒˆ ì¼ì • ì¶”ê°€
                        </button>
                    </div>
                `;
                daysHost.appendChild(daySection);
                renderDetailedActivitiesForDayInGroup(groupIndex, dayIdx);
            });
        }

        function renderDetailedActivitiesForDayInGroup(groupIndex, dayIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            const day = groupData.detailedItinerary.days[dayIndex];
            const activitiesListContainer = document.querySelector(`.activities-list-group-${groupIndex}-day-${dayIndex}`);

            if (!day || !activitiesListContainer) {
                console.error(`Day data or activities container not found for group ${groupIndex}, day ${dayIndex}`);
                return;
            }
            activitiesListContainer.innerHTML = ''; 

            day.activities.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.dataset.activityId = activity.id;
                let imageHTML = '';
                if (activity.imageUrl) { imageHTML = `<img src="${activity.imageUrl}" alt="${activity.title || 'í™œë™ ì´ë¯¸ì§€'}" class="card-image" onerror="this.style.display='none';">`; }

                card.innerHTML = `
                    <div class="card-time-icon-area">
                        <div class="card-icon">${activity.icon || ''}</div>
                        <div class="card-time">${formatTimeToHHMM(activity.time)}</div>
                    </div>
                    <div class="card-details-area">
                        <div class="card-title">${activity.title || ''}</div>
                        ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''}
                        ${imageHTML}
                        ${activity.locationLink ? `<div class="card-location">ğŸ“ <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">ìœ„ì¹˜ ë³´ê¸°</a></div>` : ''}
                        ${activity.cost ? `<div class="card-cost">ğŸ’° ${activity.cost}</div>` : ''}
                        ${activity.notes ? `<div class="card-notes">ğŸ“ ${activity.notes}</div>` : ''}
                    </div>
                    <div class="card-actions-direct">
                        <button class="icon-button edit-activity-button itinerary-planner-styles" title="ìˆ˜ì •" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="icon-button duplicate-activity-button itinerary-planner-styles" title="ë³µì œ" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-copy"></i></button>
                        <button class="icon-button delete-activity-button itinerary-planner-styles" title="ì‚­ì œ" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                activitiesListContainer.appendChild(card);
            });
        }


        function handleAddDetailedItineraryDay(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            if (!groupData) return;

            let newDate;
            const daysArray = groupData.detailedItinerary.days;
            if (daysArray.length > 0) {
                const lastDate = new Date(daysArray[daysArray.length - 1].date + "T00:00:00");
                newDate = new Date(lastDate);
                newDate.setDate(lastDate.getDate() + 1);
            } else {
                newDate = new Date(); 
            }
            daysArray.push({
                date: dateToYyyyMmDd(newDate),
                activities: [],
                isCollapsed: false,
                editingDate: false
            });
            renderDetailedItineraryForGroup(groupIndex);
        }

        // ----- Activity Modal -----
        const activityModal = document.getElementById('activityModal');
        const activityForm = document.getElementById('activityForm');
        const modalTitle = document.getElementById('modalTitle');
        const activityIconSelect = document.getElementById('activityIconSelect');
        const currentQuoteGroupIndexInput = document.getElementById('currentQuoteGroupIndex');
        const currentDayIndexInput = document.getElementById('currentDayIndex');
        const currentActivityIdInput = document.getElementById('currentActivityId');

        function populateIconDropdown() {
            activityIconSelect.innerHTML = '';
            travelEmojis.forEach(emoji => {
                const option = document.createElement('option');
                option.value = emoji.value;
                option.textContent = emoji.display;
                activityIconSelect.appendChild(option);
            });
        }

        function openActivityModal(groupIndex, dayIndex, activityId = null) {
            currentQuoteGroupIndexInput.value = groupIndex;
            currentDayIndexInput.value = dayIndex;
            activityForm.reset();
            populateIconDropdown();

            if (activityId) { 
                modalTitle.textContent = 'ì¼ì • ìˆ˜ì •';
                currentActivityIdInput.value = activityId;
                const activity = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities.find(act => act.id === activityId);
                if (activity) {
                    document.getElementById('activityTimeInput').value = activity.time || "";
                    activityIconSelect.value = activity.icon || "";
                    document.getElementById('activityTitle').value = activity.title || "";
                    document.getElementById('activityDescription').value = activity.description || "";
                    document.getElementById('activityLocation').value = activity.locationLink || "";
                    document.getElementById('activityImageUrl').value = activity.imageUrl || "";
                    document.getElementById('activityCost').value = activity.cost || "";
                    document.getElementById('activityNotes').value = activity.notes || "";
                }
            } else { 
                modalTitle.textContent = 'ìƒˆ ì¼ì • ì¶”ê°€';
                currentActivityIdInput.value = '';
                activityIconSelect.value = travelEmojis[0].value; 
            }
            activityModal.style.display = 'flex';
        }

        function closeActivityModal() {
            activityModal.style.display = 'none';
        }

        document.getElementById('cancelActivityModalButton').addEventListener('click', closeActivityModal);

        activityForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const groupIndex = currentQuoteGroupIndexInput.value;
            const dayIndex = parseInt(currentDayIndexInput.value);
            const activityId = currentActivityIdInput.value;

            const timeValue = document.getElementById('activityTimeInput').value.trim();
            if (timeValue && (timeValue.length !== 4 || !/^\d{4}$/.test(timeValue))) {
                showToast("ì‹œê°„ì€ HHMM í˜•ì‹ì˜ 4ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•˜ê±°ë‚˜ ë¹„ì›Œë‘ì„¸ìš”.");
                return;
            }
            if (timeValue.length === 4) {
                const hours = parseInt(timeValue.substring(0, 2), 10);
                const minutes = parseInt(timeValue.substring(2, 4), 10);
                if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    showToast("ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œê°„ì…ë‹ˆë‹¤. HHëŠ” 00-23, MMì€ 00-59 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
            }

            const activityData = {
                id: activityId || generateId(),
                time: timeValue,
                icon: activityIconSelect.value,
                title: document.getElementById('activityTitle').value,
                description: document.getElementById('activityDescription').value,
                locationLink: document.getElementById('activityLocation').value,
                imageUrl: document.getElementById('activityImageUrl').value,
                cost: document.getElementById('activityCost').value,
                notes: document.getElementById('activityNotes').value,
            };

            const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
            if (activityId) { 
                const activityIndex = dayActivities.findIndex(act => act.id === activityId);
                if (activityIndex > -1) {
                    dayActivities[activityIndex] = activityData;
                }
            } else { 
                dayActivities.push(activityData);
            }
            renderDetailedItineraryForGroup(groupIndex);
            closeActivityModal();
        });


        // ----- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -----
        document.addEventListener('DOMContentLoaded', function() {
            enableSelectOnFocus('div.container'); 
            createQuoteGroup(quoteGroupCounter++); 
            populateIconDropdown(); 

            document.getElementById('addGlobalQuoteGroupBtn').addEventListener('click', function() {
                const newGroupElement = createQuoteGroup(quoteGroupCounter++);
                if (newGroupElement) {
                    newGroupElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const titleInputToFocus = newGroupElement.querySelector('input[name^="quote_group_title"]');
                    if (titleInputToFocus) setTimeout(() => titleInputToFocus.focus(), 300);
                }
            });

            document.getElementById('quoteGroupsContainer').addEventListener('click', function(e) {
                const target = e.target;
                const quoteGroupElement = target.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                // ìƒì„¸ ì¼ì • ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                if (target.closest('.add-detailed-itinerary-day-button')) {
                    handleAddDetailedItineraryDay(groupIndex);
                } else if (target.closest('.add-activity-to-day-button')) {
                    const dayIndex = target.closest('.add-activity-to-day-button').dataset.dayIndex;
                    openActivityModal(groupIndex, parseInt(dayIndex));
                } else if (target.closest('.edit-detailed-date-button')) {
                    const dayIndex = parseInt(target.closest('.edit-detailed-date-button').dataset.dayIndex);
                    handleEditDayDate(groupIndex, dayIndex);
                } else if (target.closest('.save-detailed-date-button')) {
                    const dayIndex = parseInt(target.closest('.save-detailed-date-button').dataset.dayIndex);
                    handleSaveDayDate(groupIndex, dayIndex);
                } else if (target.closest('.cancel-detailed-date-edit-button')) {
                    const dayIndex = parseInt(target.closest('.cancel-detailed-date-edit-button').dataset.dayIndex);
                    handleCancelEditDayDate(groupIndex, dayIndex);
                } else if (target.closest('.delete-detailed-day-button')) {
                    const dayIndex = parseInt(target.closest('.delete-detailed-day-button').dataset.dayIndex);
                    handleDeleteDetailedItineraryDay(groupIndex, dayIndex);
                } else if (target.closest('.toggle-detailed-day-collapse-button')) {
                    const dayIndex = parseInt(target.closest('.toggle-detailed-day-collapse-button').dataset.dayIndex);
                    handleToggleDayCollapse(groupIndex, dayIndex);
                } else if (target.closest('.edit-activity-button')) {
                    const dayIndex = parseInt(target.closest('.edit-activity-button').dataset.dayIndex);
                    const activityId = target.closest('.edit-activity-button').dataset.activityId;
                    openActivityModal(groupIndex, dayIndex, activityId);
                } else if (target.closest('.duplicate-activity-button')) {
                    const dayIndex = parseInt(target.closest('.duplicate-activity-button').dataset.dayIndex);
                    const activityId = target.closest('.duplicate-activity-button').dataset.activityId;
                    handleDuplicateActivity(groupIndex, dayIndex, activityId);
                } else if (target.closest('.delete-activity-button')) {
                    const dayIndex = parseInt(target.closest('.delete-activity-button').dataset.dayIndex);
                    const activityId = target.closest('.delete-activity-button').dataset.activityId;
                    handleDeleteActivity(groupIndex, dayIndex, activityId);
                }


                // ê¸°ì¡´ ê²¬ì  ê·¸ë£¹ ê¸°ëŠ¥ë“¤
                const priceSubgroupElement = target.closest('.price-subgroup');
                if (target.closest('.delete-quote-group-btn')) {
                    if (window.confirm('ì´ ê²¬ì  ê·¸ë£¹ ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
                        delete quoteGroupDataStore[groupIndex]; 
                        quoteGroupElement.remove();
                    }
                } else if (target.closest('.copy-quote-group-btn')) {
                    showToast('ê·¸ë£¹ ë³µì‚¬ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
                } else if (target.closest('.delete-dynamic-section-btn')) {
                    const dynamicSection = target.closest('.dynamic-section');
                    if (dynamicSection) {
                        const subGroupIndex = dynamicSection.dataset.subGroupIndex;
                        if (dynamicSection.classList.contains('price-subgroup')) {
                            quoteGroupDataStore[groupIndex].priceSubgroups.splice(subGroupIndex, 1);
                        } else if (dynamicSection.classList.contains('flight-schedule-subgroup')) {
                            quoteGroupDataStore[groupIndex].flightSubgroups.splice(subGroupIndex, 1);
                        }
                        dynamicSection.remove();
                        if (priceSubgroupElement) { 
                            const parentPriceSubgroup = dynamicSection.closest('.price-subgroup');
                            if(parentPriceSubgroup) updateGrandTotalForSubgroup(parentPriceSubgroup);
                        }
                    }
                } else if (target.closest('.delete-row')) {
                    const row = target.closest('tr');
                    const tableBody = row.parentElement;
                    const subGroupElement = target.closest('.dynamic-section'); 
                    if(row && subGroupElement){ 
                        const groupIndex = subGroupElement.dataset.groupIndex;
                        const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                        const rowIndex = Array.from(tableBody.children).indexOf(row);

                        if(subGroupElement.classList.contains('price-subgroup')){
                            quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows.splice(rowIndex, 1);
                            updateGrandTotalForSubgroup(subGroupElement); 
                        } else if (subGroupElement.classList.contains('flight-schedule-subgroup')){
                             quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows.splice(rowIndex, 1);
                        }
                        row.remove();
                    } else if (row && tableBody.id.startsWith('itineraryTableBody_')) { 
                        const groupIndex = target.closest('.quote-group-section').dataset.groupIndex;
                        const rowIndex = Array.from(tableBody.children).indexOf(row);
                        quoteGroupDataStore[groupIndex].itinerarySummaryRows.splice(rowIndex, 1);
                        row.remove();
                    }
                } else if (target.closest('.add-price-subgroup-button')) {
                     // Logic is in initPriceSectionForGroup's event listener
                } else if (target.closest('.add-flight-subgroup-button')) { 
                    // Logic is in initFlightScheduleForGroup's event listener
                } else if (target.closest('.add-itinerary-row-to-group')) { 
                    const itineraryTbody = quoteGroupElement.querySelector(`#itineraryTableBody_${groupIndex}`);
                    const newRowData = { dayNo: "", dayDate: "", sCity: "", eCity: "", hotel: "", traffic: "", bigo: "" };
                    if (!quoteGroupDataStore[groupIndex].itinerarySummaryRows) {
                        quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
                    }
                    quoteGroupDataStore[groupIndex].itinerarySummaryRows.push(newRowData);
                    addItineraryRowForGroupUI(itineraryTbody, groupIndex, newRowData.dayNo, newRowData.dayDate, newRowData.sCity, newRowData.eCity, newRowData.hotel, newRowData.traffic, newRowData.bigo);
                }
            });

             document.getElementById('quoteGroupsContainer').addEventListener('input', function(e) {
                const target = e.target;
                const quoteGroupElement = target.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                if (target.matches('input[name^="quote_group_title"]')) {
                    quoteGroupDataStore[groupIndex].groupTitle = target.value;
                } else if (target.matches('textarea[name^="included_items_textarea"]')) {
                    quoteGroupDataStore[groupIndex].inclusionExclusion.includedTextarea = target.value;
                } else if (target.matches('textarea[name^="excluded_items_textarea"]')) {
                    quoteGroupDataStore[groupIndex].inclusionExclusion.excludedTextarea = target.value;
                } else if (target.matches('input[name^="price_subgroup_title"]')) {
                    const subGroupIndex = target.closest('.price-subgroup').dataset.subGroupIndex;
                    quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].title = target.value;
                } else if (target.matches('input[name^="flight_group_title"]')) { 
                    const subGroupIndex = target.closest('.flight-schedule-subgroup').dataset.subGroupIndex;
                    quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].title = target.value;
                } else if (target.classList.contains('flight-schedule-input')) {
                    const subGroupElement = target.closest('.flight-schedule-subgroup');
                    const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                    const rowElement = target.closest('tr');
                    const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                    const field = target.dataset.field;
                    if(quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex] && quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows[rowIndex]){
                        quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows[rowIndex][field] = target.value;
                    }
                } else if (target.classList.contains('itinerary-schedule-input')) { 
                    const rowElement = target.closest('tr');
                    const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                    const field = target.dataset.field; 
                    if (quoteGroupDataStore[groupIndex].itinerarySummaryRows[rowIndex]) {
                         quoteGroupDataStore[groupIndex].itinerarySummaryRows[rowIndex][field] = target.value;
                    }
                }


                if (target.matches('.price-per-person, .person-count')) {
                    const subgroupElement = target.closest('.price-subgroup');
                    if (subgroupElement) updateRowTotalForSubgroup(e, subgroupElement);
                }
            });

             document.getElementById('quoteGroupsContainer').addEventListener('paste', function(e) {
                const targetInput = e.target;
                const quoteGroupElement = targetInput.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                if (targetInput.matches('.flight-schedule-input')) {
                    const flightSubgroupElement = targetInput.closest('.flight-schedule-subgroup');
                    if (flightSubgroupElement) {
                        const subGroupIndex = flightSubgroupElement.dataset.subGroupIndex;
                        handlePasteToFlightTableForSubgroup(e, groupIndex, subGroupIndex);
                    }
                } else if (targetInput.matches('.itinerary-schedule-input')) {
                    const itineraryTableBody = targetInput.closest('tbody.itinerary-table-body-for-group');
                    if (itineraryTableBody) {
                        handlePasteToItineraryTableForGroup(e, itineraryTableBody, groupIndex);
                    }
                }
            });


            const loadQuoteFileInput = document.getElementById('loadQuoteFile');
            if (loadQuoteFileInput) {
                loadQuoteFileInput.addEventListener('change', function(event) {
                    showToast('ê²¬ì  ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
                    event.target.value = null;
                });
            }
        });
        
        function enableSelectOnFocus(containerSelector = 'body') { 
            const container = document.querySelector(containerSelector);
            if (!container) return;
            container.addEventListener('focusin', function(event) {
                const target = event.target;
                if (target.matches('input[type="text"], input[type="email"], input[type="number"], textarea')) {
                    if (typeof target.select === 'function' && !target.isContentEditable) {
                        setTimeout(() => { target.select(); }, 0);
                    }
                }
            });
        }

        function initPriceSectionForGroup(quoteGroupElement, groupIndex, sourcePriceSubgroups = null) {
            const addPriceSubgroupButton = quoteGroupElement.querySelector('.add-price-subgroup-button');
            const priceSectionsContainer = quoteGroupElement.querySelector(`#priceSectionsContainer_${groupIndex}`);
            
            if (!quoteGroupDataStore[groupIndex].priceSubgroups) {
                quoteGroupDataStore[groupIndex].priceSubgroups = [];
            }
            let currentSubgroups = quoteGroupDataStore[groupIndex].priceSubgroups;

            if (addPriceSubgroupButton) {
                 addPriceSubgroupButton.addEventListener('click', () => {
                    const newSubgroupData = {title: "", rows: [
                        { title: "ì„±ì¸ìš”ê¸ˆ", perPrice: "0", number: 1, bigo: "" },
                        { title: "ì†Œì•„ìš”ê¸ˆ", perPrice: "0", number: 0, bigo: "2~12ì„¸ë¯¸ë§Œ(ì¢Œì„ì ìœ )" },
                        { title: "ìœ ì•„ìš”ê¸ˆ", perPrice: "0", number: 0, bigo: "24ê°œì›”ë¯¸ë§Œ(ì¢Œì„ë¯¸ì ìœ )" }
                    ]};
                    currentSubgroups.push(newSubgroupData); 
                    createPriceSubgroup(priceSectionsContainer, groupIndex, currentSubgroups.length - 1, newSubgroupData); 
                });
            }

            if (currentSubgroups.length > 0) {
                currentSubgroups.forEach((subgroupData, idx) => {
                    createPriceSubgroup(priceSectionsContainer, groupIndex, idx, subgroupData);
                });
            } else { 
                const defaultSubgroupData = {title: "", rows: [
                    { title: "ì„±ì¸ìš”ê¸ˆ", perPrice: "0", number: 1, bigo: "" },
                    { title: "ì†Œì•„ìš”ê¸ˆ", perPrice: "0", number: 0, bigo: "2~12ì„¸ë¯¸ë§Œ(ì¢Œì„ì ìœ )" },
                    { title: "ìœ ì•„ìš”ê¸ˆ", perPrice: "0", number: 0, bigo: "24ê°œì›”ë¯¸ë§Œ(ì¢Œì„ë¯¸ì ìœ )" }
                ]};
                currentSubgroups.push(defaultSubgroupData);
                createPriceSubgroup(priceSectionsContainer, groupIndex, 0, defaultSubgroupData);
            }
        }
        function createPriceSubgroup(container, groupIndex, subGroupIndex, sourceSubgroupData = null) {
            const sectionId = `priceSection_${groupIndex}_${subGroupIndex}`;
            const tableBodyId = `priceTableBody_${groupIndex}_${subGroupIndex}`;
            const grandTotalId = `grandTotal_${groupIndex}_${subGroupIndex}`;
            const groupTitleInputName = `price_subgroup_title[${groupIndex}][${subGroupIndex}]`;
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'dynamic-section price-subgroup';
            sectionDiv.id = sectionId;
            sectionDiv.dataset.groupIndex = groupIndex;
            sectionDiv.dataset.subGroupIndex = subGroupIndex;

            const initialSubgroupTitle = sourceSubgroupData ? sourceSubgroupData.title : "";
            sectionDiv.innerHTML = `
                <button type="button" class="delete-dynamic-section delete-dynamic-section-btn text-red-500 hover:text-red-700" title="ì´ ìš”ê¸ˆ ì†Œê·¸ë£¹ ì‚­ì œ"><i class="fas fa-trash-alt mr-1"></i>ì‚­ì œ</button>
                <div class="mb-2">
                    <input type="text" name="${groupTitleInputName}" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-md font-semibold" placeholder="ê²¬ì ì„¤ëª… (ì˜ˆ: ì¸ì²œì¶œë°œ, ê¹€í•´ì¶œë°œ, Aê°ì‹¤, Bê°ì‹¤)" value="${initialSubgroupTitle}">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border price-table text-sm">
                        <thead><tr class="bg-gray-100">
                            <th class="border p-2 text-center" style="width: 20%;">ë‚´ì—­</th><th class="border p-2 text-center" style="width: 15%;">1ì¸ë‹¹ ê¸ˆì•¡</th>
                            <th class="border p-2 text-center" style="width: 8%;">ì¸ì›</th><th class="border p-2 text-center" style="width: 17%;">ì´ ê¸ˆì•¡</th>
                            <th class="border p-2 text-center">ë¹„ê³ </th><th class="border p-2 text-center w-12">ì‚­ì œ</th></tr></thead>
                        <tbody id="${tableBodyId}" class="price-table-body"></tbody>
                        <tfoot><tr>
                            <td colspan="3" class="border p-2 text-right font-bold text-xs">ì´ í•©ê³„</td>
                            <td class="border p-1 font-bold"><input type="text" name="p_sumprice[${groupIndex}][${subGroupIndex}]" id="${grandTotalId}" class="w-full border-0 focus:ring-0 grand-total-input text-xs p-1" value="0" readonly></td>
                            <td colspan="2" class="border p-2"><button type="button" class="add-price-row-to-subgroup bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs"><i class="fas fa-plus mr-1"></i> í–‰ ì¶”ê°€</button></td>
                        </tr></tfoot>
                    </table>
                </div>`;
            container.appendChild(sectionDiv);
            const tbody = sectionDiv.querySelector('.price-table-body');
            const rowsToRender = (sourceSubgroupData && sourceSubgroupData.rows && sourceSubgroupData.rows.length > 0) 
                                ? sourceSubgroupData.rows 
                                : [ 
                                    { title: "ì„±ì¸ìš”ê¸ˆ", perPrice: "0", number: 1, bigo: "" },
                                    { title: "ì†Œì•„ìš”ê¸ˆ", perPrice: "0", number: 0, bigo: "2~12ì„¸ë¯¸ë§Œ(ì¢Œì„ì ìœ )" },
                                    { title: "ìœ ì•„ìš”ê¸ˆ", perPrice: "0", number: 0, bigo: "24ê°œì›”ë¯¸ë§Œ(ì¢Œì„ë¯¸ì ìœ )" }
                                  ];
            
            rowsToRender.forEach(rowData => addPriceRowToExistingSubgroup(null, sectionDiv, rowData));
            initPriceTableForSubgroup(sectionDiv);
            return sectionDiv;
        }
        function initPriceTableForSubgroup(subgroupElement) { 
            subgroupElement.querySelectorAll('.price-table-body tr').forEach(row => {
                const firstInput = row.querySelector('.price-per-person');
                if (firstInput) updateRowTotalForSubgroup({ target: firstInput }, subgroupElement);
            });
            const addRowButton = subgroupElement.querySelector('.add-price-row-to-subgroup');
            if (addRowButton) addRowButton.addEventListener('click', (e) => addPriceRowToExistingSubgroup(e, subgroupElement));
        }
        function updateRowTotalForSubgroup(event, subgroupElement) { 
            const row = event.target.closest('tr'); if (!row) return;
            const pricePerPersonInput = row.querySelector('.price-per-person');
            const personCountInput = row.querySelector('.person-count');
            const totalPriceInput = row.querySelector('.total-price');
            if (!pricePerPersonInput || !personCountInput || !totalPriceInput) return;
            const pricePerPerson = parseFloat(pricePerPersonInput.value) || 0;
            const personCount = parseInt(personCountInput.value) || 0;
            totalPriceInput.value = (pricePerPerson * personCount).toLocaleString();
            updateGrandTotalForSubgroup(subgroupElement);
        }
        function updateGrandTotalForSubgroup(subgroupElement) { 
            let grandTotal = 0;
            subgroupElement.querySelectorAll('.price-table-body .total-price').forEach(cell => grandTotal += parseFloat(cell.value.replace(/,/g, '')) || 0);
            const grandTotalInput = subgroupElement.querySelector('.grand-total-input');
            if (grandTotalInput) grandTotalInput.value = grandTotal.toLocaleString();
        }
        function addPriceRowToExistingSubgroup(event, subgroupElement, rowData = null) { 
            const tbody = subgroupElement.querySelector('.price-table-body');
            const groupIndex = subgroupElement.dataset.groupIndex;
            const subGroupIndex = subgroupElement.dataset.subGroupIndex;
            if (!tbody || groupIndex === undefined || subGroupIndex === undefined) return;

            const titleVal = rowData ? rowData.title : "ì¶”ê°€ ë¹„ìš©";
            const perPriceVal = rowData ? rowData.perPrice : "0";
            const numberVal = rowData ? rowData.number : "1";
            const bigoVal = rowData ? rowData.bigo : "";

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border p-1"><input type="text" name="p_title[${groupIndex}][${subGroupIndex}][]" value="${titleVal}" class="w-full border-0 focus:ring-0"></td>
                <td class="border p-1"><input type="number" name="p_perprice[${groupIndex}][${subGroupIndex}][]" class="price-per-person w-full border-0 focus:ring-0" value="${perPriceVal}"></td>
                <td class="border p-1"><input type="number" name="p_number[${groupIndex}][${subGroupIndex}][]" class="person-count w-full border-0 focus:ring-0" value="${numberVal}"></td>
                <td class="border p-1"><input type="text" name="p_totalprice[${groupIndex}][${subGroupIndex}][]" class="w-full border-0 focus:ring-0 total-price" value="0" readonly></td>
                <td class="border p-1"><input type="text" name="p_bigo[${groupIndex}][${subGroupIndex}][]" class="w-full border-0 focus:ring-0" value="${bigoVal}"></td>
                <td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700" title="ì‚­ì œ"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);
            
            const firstInput = tr.querySelector('.price-per-person');
            if (firstInput) updateRowTotalForSubgroup({ target: firstInput }, subgroupElement);

            if (event) { 
                if (!quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows) {
                    quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows = [];
                }
                quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows.push({
                    title: titleVal, perPrice: perPriceVal, number: numberVal, bigo: bigoVal
                });
            }
        }

        function initFlightScheduleForGroup(quoteGroupElement, groupIndex, sourceFlightSubgroups = null) {
            const addFlightSubgroupButton = quoteGroupElement.querySelector('.add-flight-subgroup-button');
            const flightScheduleContainer = quoteGroupElement.querySelector(`#flightScheduleGroupsContainer_${groupIndex}`);
            
            if (!quoteGroupDataStore[groupIndex].flightSubgroups) {
                quoteGroupDataStore[groupIndex].flightSubgroups = [];
            }
            let currentSubgroups = quoteGroupDataStore[groupIndex].flightSubgroups;

            if (addFlightSubgroupButton) {
                addFlightSubgroupButton.addEventListener('click', () => {
                    const newSubgroupData = { title: "", rows: [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }] };
                    currentSubgroups.push(newSubgroupData);
                    createFlightSubgroup(flightScheduleContainer, groupIndex, currentSubgroups.length - 1, newSubgroupData);
                });
            }

            if (currentSubgroups.length > 0) {
                currentSubgroups.forEach((subgroupData, idx) => {
                    createFlightSubgroup(flightScheduleContainer, groupIndex, idx, subgroupData);
                });
            } else {
                const defaultSubgroupData = { title: "", rows: [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }] };
                currentSubgroups.push(defaultSubgroupData);
                createFlightSubgroup(flightScheduleContainer, groupIndex, 0, defaultSubgroupData);
            }
        }

        function createFlightSubgroup(container, groupIndex, subGroupIndex, sourceSubgroupData = null) {
            const groupId = `flightScheduleGroup_${groupIndex}_${subGroupIndex}`;
            const tableBodyId = `flightTableBody_${groupIndex}_${subGroupIndex}`;
            const groupTitleInputName = `flight_group_title[${groupIndex}][${subGroupIndex}]`; 
            const groupDiv = document.createElement('div');
            groupDiv.className = 'dynamic-section flight-schedule-subgroup';
            groupDiv.id = groupId;
            groupDiv.dataset.groupIndex = groupIndex;
            groupDiv.dataset.subGroupIndex = subGroupIndex;

            const initialTitle = sourceSubgroupData ? sourceSubgroupData.title : ""; 
            groupDiv.innerHTML = `
                <button type="button" class="delete-dynamic-section delete-dynamic-section-btn text-red-500 hover:text-red-700" title="ì´ í•­ê³µ ìŠ¤ì¼€ì¤„ ì†Œê·¸ë£¹ ì‚­ì œ"><i class="fas fa-trash-alt mr-1"></i>ì‚­ì œ</button>
                <div class="mb-2">
                    <input type="text" name="${groupTitleInputName}" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-md font-semibold" placeholder="í•­ê³µì‚¬ (ì˜ˆ: ì´ìŠ¤íƒ€í•­ê³µ)" value="${initialTitle}">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border text-sm">
                        <thead><tr class="bg-gray-100">
                            <th class="border p-2 text-left text-xs">í¸ëª…</th><th class="border p-2 text-left text-xs">ì¶œë°œì¼</th>
                            <th class="border p-2 text-left text-xs">ì¶œë°œì§€</th><th class="border p-2 text-left text-xs">ì¶œë°œì‹œê°„</th>
                            <th class="border p-2 text-left text-xs">ë„ì°©ì¼</th><th class="border p-2 text-left text-xs">ë„ì°©ì§€</th>
                            <th class="border p-2 text-left text-xs">ë„ì°©ì‹œê°„</th><th class="border p-2 text-center w-12 text-xs">ì‚­ì œ</th></tr></thead>
                        <tbody id="${tableBodyId}" class="flight-table-body-subgroup"></tbody>
                        <tfoot><tr><td colspan="8" class="border p-2">
                            <button type="button" class="add-flight-row-to-subgroup bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs">
                                <i class="fas fa-plus mr-1"></i> í–‰ ì¶”ê°€
                            </button>
                        </td></tr></tfoot>
                    </table>
                </div>`;
            container.appendChild(groupDiv);
            const tbody = groupDiv.querySelector(`#${tableBodyId}`);
            const rowsToRender = (sourceSubgroupData && sourceSubgroupData.rows && sourceSubgroupData.rows.length > 0) 
                                ? sourceSubgroupData.rows 
                                : [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }];
            
            rowsToRender.forEach(rowData => {
                addFlightRowForSubgroup(tbody, groupIndex, subGroupIndex, rowData.flightNum, rowData.depDate, rowData.originCity, rowData.depTime, rowData.arrDate, rowData.destCity, rowData.arrTime);
            });

            const addFlightRowButton = groupDiv.querySelector('.add-flight-row-to-subgroup');
            if(addFlightRowButton) {
                addFlightRowButton.addEventListener('click', () => {
                    const targetTbody = groupDiv.querySelector('tbody.flight-table-body-subgroup');
                    if (targetTbody) {
                         const newRowData = { flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" };
                         quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows.push(newRowData);
                         addFlightRowForSubgroup(targetTbody, groupIndex, subGroupIndex); 
                    }
                });
            }
            // Add paste listener to the subgroup div
            groupDiv.addEventListener('paste', (e) => handlePasteToFlightTableForSubgroup(e, groupIndex, subGroupIndex));
            return groupDiv;
        }

        function addFlightRowForSubgroup(tbodyElement, groupIndex, subGroupIndex, flightNum = "", depDate = "", originCity = "", depTime = "", arrDate = "", destCity = "", arrTime = "") {
            if (!tbodyElement) return null; 
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border p-1"><input type="text" name="dep_trans_flight_group[${groupIndex}][${subGroupIndex}][]" data-field="flightNum" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${flightNum}" placeholder="ZE 561"></td>
                <td class="border p-1"><input type="text" name="start_day_group[${groupIndex}][${subGroupIndex}][]" data-field="depDate" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${depDate}" placeholder="07ì›” 09ì¼"></td>
                <td class="border p-1"><input type="text" name="dep_start_city_cd_group[${groupIndex}][${subGroupIndex}][]" data-field="originCity" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${originCity}" placeholder="ì¸ì²œ"></td>
                <td class="border p-1"><input type="text" name="dep_start_time_group[${groupIndex}][${subGroupIndex}][]" data-field="depTime" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${depTime}" placeholder="20:55"></td>
                <td class="border p-1"><input type="text" name="arrival_day_group[${groupIndex}][${subGroupIndex}][]" data-field="arrDate" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${arrDate}" placeholder="07ì›” 09ì¼"></td>
                <td class="border p-1"><input type="text" name="dep_end_city_cd_group[${groupIndex}][${subGroupIndex}][]" data-field="destCity" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${destCity}" placeholder="ë‚˜íŠ¸ë‘"></td>
                <td class="border p-1"><input type="text" name="dep_end_time_group[${groupIndex}][${subGroupIndex}][]" data-field="arrTime" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${arrTime}" placeholder="23:55"></td>
                <td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="ì‚­ì œ"><i class="fas fa-trash"></i></button></td>`;
            tbodyElement.appendChild(tr); 
            return tr;
        }
        
        function initInclusionExclusionForGroup(quoteGroupElement, groupIndex, sourceData = null) { /* ... original ... */ }
        
        // ê°„ë‹¨ ì¼ì • í•¨ìˆ˜ ìˆ˜ì •
        function initItinerarySummaryForGroup(quoteGroupElement, groupIndex, sourceItineraryRows = null) {
            const tbody = quoteGroupElement.querySelector(`#itineraryTableBody_${groupIndex}`);
            tbody.innerHTML = ''; 

            if (!quoteGroupDataStore[groupIndex].itinerarySummaryRows) {
                quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
            }
            
            if (sourceItineraryRows && sourceItineraryRows.length > 0 && quoteGroupDataStore[groupIndex].itinerarySummaryRows.length === 0) { 
                quoteGroupDataStore[groupIndex].itinerarySummaryRows = JSON.parse(JSON.stringify(sourceItineraryRows)); 
            }
            
            quoteGroupDataStore[groupIndex].itinerarySummaryRows.forEach(rowData => {
                addItineraryRowForGroupUI(tbody, groupIndex, rowData.dayNo, rowData.dayDate, rowData.sCity, rowData.eCity, rowData.hotel, rowData.traffic, rowData.bigo);
            });
        }

        // UI Rendering function for itinerary summary rows
        function addItineraryRowForGroupUI(tbodyElement, groupIndex, dayNoVal = "", dayDateVal = "", sCityVal = "", eCityVal = "", hotelVal = "", trafficVal = "", bigoVal = "") {
            if (!tbodyElement) {
                console.error("tbodyElement is null in addItineraryRowForGroupUI for groupIndex:", groupIndex);
                return null;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border p-1"><input type="text" name="schdule_no[${groupIndex}][]" data-field="dayNo" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${dayNoVal}" placeholder="1"></td>
                <td class="border p-1"><input type="text" name="schdule_day[${groupIndex}][]" data-field="dayDate" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${dayDateVal}" placeholder="12ì›” 28ì¼"></td>
                <td class="border p-1"><input type="text" name="schdule_scity[${groupIndex}][]" data-field="sCity" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${sCityVal}" placeholder="ì¸ì²œ"></td>
                <td class="border p-1"><input type="text" name="schdule_ecity[${groupIndex}][]" data-field="eCity" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${eCityVal}" placeholder="í‘¸ê¾¸ì˜¥"></td>
                <td class="border p-1"><input type="text" name="schdule_hotel[${groupIndex}][]" data-field="hotel" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${hotelVal}" placeholder="ë²„ê³ í˜¸í…”"></td>
                <td class="border p-1"><input type="text" name="schdule_traffic[${groupIndex}][]" data-field="traffic" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${trafficVal}" placeholder="í•­ê³µ"></td>
                <td class="border p-1"><input type="text" name="schdule_bigo[${groupIndex}][]" data-field="bigo" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${bigoVal}"></td>
                <td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="ì‚­ì œ"><i class="fas fa-trash"></i></button></td>`;
            tbodyElement.appendChild(tr);
            return tr;
        }

        // ----- ë¶™ì—¬ë„£ê¸° í•¸ë“¤ëŸ¬ í•¨ìˆ˜ -----
        function handlePasteToFlightTableForSubgroup(event, groupIndex, subGroupIndex) {
            const targetInput = event.target;
            if (!targetInput.matches('.flight-schedule-input')) return;
            event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text/plain');
            const rowsOfData = pasteData.split(/\r\n|\n|\r/);

            let currentRowElement = targetInput.closest('tr');
            let currentCellIndexInRow = Array.from(currentRowElement.cells).indexOf(targetInput.closest('td'));
            const currentTbody = currentRowElement.closest('tbody.flight-table-body-subgroup');
            const flightSubgroupData = quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex];

            rowsOfData.forEach((rowText, pasteRowIndex) => {
                if (!rowText.trim()) return;
                const cellsOfData = rowText.split('\t');
                let currentTbodyRowIndex = Array.from(currentTbody.children).indexOf(currentRowElement);

                if (!currentRowElement) { 
                    const newRowData = { flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" };
                    flightSubgroupData.rows.push(newRowData);
                    currentRowElement = addFlightRowForSubgroup(currentTbody, groupIndex, subGroupIndex); 
                    if (!currentRowElement) return;
                    currentCellIndexInRow = 0;
                    currentTbodyRowIndex = flightSubgroupData.rows.length -1; 
                }
                
                const inputFieldsInCurrentRow = currentRowElement.querySelectorAll('.flight-schedule-input');
                let dataCellIdx = 0;
                for (let i = currentCellIndexInRow; i < inputFieldsInCurrentRow.length && dataCellIdx < cellsOfData.length; i++) {
                    const fieldName = inputFieldsInCurrentRow[i].dataset.field;
                    const pastedValue = cellsOfData[dataCellIdx].trim();
                    inputFieldsInCurrentRow[i].value = pastedValue;
                    if (flightSubgroupData.rows[currentTbodyRowIndex]) {
                         flightSubgroupData.rows[currentTbodyRowIndex][fieldName] = pastedValue;
                    }
                    dataCellIdx++;
                }
                const nextTRElement = currentRowElement.nextElementSibling;
                currentRowElement = (nextTRElement && nextTRElement.cells.length > 0) ? nextTRElement : null;
                currentCellIndexInRow = 0; 
            });
        }

        function handlePasteToItineraryTableForGroup(event, tbodyElement, groupIndex) {
            const targetInput = event.target;
            if (!targetInput.matches('.itinerary-schedule-input')) return;
            event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text/plain');
            const rowsOfData = pasteData.split(/\r\n|\n|\r/);

            let currentRowElement = targetInput.closest('tr');
            let currentCellIndexInRow = Array.from(currentRowElement.cells).indexOf(targetInput.closest('td'));
            const summaryRowsData = quoteGroupDataStore[groupIndex].itinerarySummaryRows;

            rowsOfData.forEach((rowText, pasteRowIndex) => {
                if (!rowText.trim()) return;
                const cellsOfData = rowText.split('\t');
                let currentTbodyRowIndex = Array.from(tbodyElement.children).indexOf(currentRowElement);

                if (!currentRowElement) { 
                    const newRowData = { dayNo: "", dayDate: "", sCity: "", eCity: "", hotel: "", traffic: "", bigo: "" };
                    summaryRowsData.push(newRowData);
                    currentRowElement = addItineraryRowForGroupUI(tbodyElement, groupIndex); 
                    if (!currentRowElement) return;
                    currentCellIndexInRow = 0;
                    currentTbodyRowIndex = summaryRowsData.length -1;
                }
                
                const inputFieldsInCurrentRow = currentRowElement.querySelectorAll('.itinerary-schedule-input');
                let dataCellIdx = 0;
                for (let i = currentCellIndexInRow; i < inputFieldsInCurrentRow.length && dataCellIdx < cellsOfData.length; i++) {
                    const fieldName = inputFieldsInCurrentRow[i].dataset.field;
                    const pastedValue = cellsOfData[dataCellIdx].trim();
                    inputFieldsInCurrentRow[i].value = pastedValue;
                    if (summaryRowsData[currentTbodyRowIndex]) {
                        summaryRowsData[currentTbodyRowIndex][fieldName] = pastedValue;
                    }
                    dataCellIdx++;
                }
                const nextTRElement = currentRowElement.nextElementSibling;
                currentRowElement = (nextTRElement && nextTRElement.cells.length > 0) ? nextTRElement : null;
                currentCellIndexInRow = 0;
            });
        }
        
        // --- ìƒì„¸ ì¼ì • ë‚ ì§œ/í™œë™ ì œì–´ í•¨ìˆ˜ ---
        function isValidDateString(dateString) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString) && !/^\d{8}$/.test(dateString)) return false;
            let year, month, day;
            if (dateString.includes('-')) {
                const parts = dateString.split("-");
                year = parseInt(parts[0], 10);
                month = parseInt(parts[1], 10);
                day = parseInt(parts[2], 10);
            } else {
                year = parseInt(dateString.substring(0,4), 10);
                month = parseInt(dateString.substring(4,6), 10);
                day = parseInt(dateString.substring(6,8), 10);
            }
            if (year < 1000 || year > 3000 || month === 0 || month > 12) return false;
            const monthLength = [31, (year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if (day === 0 || day > monthLength[month - 1]) return false;
            return true;
        }

        function parseAndFormatDateInput(inputValue) {
            let dateStr = inputValue.trim();
            if (/^\d{8}$/.test(dateStr)) { 
                return `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
            } else if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            return null; 
        }

        function recalculateAllDetailedDates(groupIndex, startingDayIndex) {
            const daysArray = quoteGroupDataStore[groupIndex].detailedItinerary.days;
            if (daysArray.length > startingDayIndex) { // Ensure startingDayIndex is valid
                let currentDate = new Date(daysArray[startingDayIndex].date + "T00:00:00");
                for (let i = startingDayIndex + 1; i < daysArray.length; i++) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    daysArray[i].date = dateToYyyyMmDd(currentDate);
                }
            }
        }

        function handleEditDayDate(groupIndex, dayIndex) {
            quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = true;
            renderDetailedItineraryForGroup(groupIndex);
            const inputField = document.querySelector(`#detailedItineraryContainer_${groupIndex} .day-section[data-day-index="${dayIndex}"] .date-edit-input`);
            if (inputField) inputField.focus();
        }

        function handleSaveDayDate(groupIndex, dayIndex) {
            const inputField = document.querySelector(`#detailedItineraryContainer_${groupIndex} .day-section[data-day-index="${dayIndex}"] .date-edit-input`);
            if (inputField) {
                const validatedDate = parseAndFormatDateInput(inputField.value);
                if (validatedDate && isValidDateString(validatedDate)) {
                    quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].date = validatedDate;
                    quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = false;
                    recalculateAllDetailedDates(groupIndex, dayIndex);
                    renderDetailedItineraryForGroup(groupIndex);
                } else {
                    showToast("ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. (YYYY-MM-DD ë˜ëŠ” YYMMDD)", 3000); 
                }
            }
        }
        function handleCancelEditDayDate(groupIndex, dayIndex) {
            quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = false;
            renderDetailedItineraryForGroup(groupIndex);
        }
        function handleDeleteDetailedItineraryDay(groupIndex, dayIndex) {
            if (window.confirm(`DAY ${dayIndex + 1} ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                quoteGroupDataStore[groupIndex].detailedItinerary.days.splice(dayIndex, 1);
                if (quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0) {
                     if (dayIndex === 0 && quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0) {
                        // If the first day was deleted and there are still other days,
                        // the next day (now at index 0) becomes the new reference.
                        // No specific recalculation needed here as render will re-number.
                    } else if (dayIndex > 0) { // If a non-first day was deleted, recalculate from the previous day
                         recalculateAllDetailedDates(groupIndex, dayIndex -1 );
                    }
                }
                renderDetailedItineraryForGroup(groupIndex);
            }
        }
        function handleToggleDayCollapse(groupIndex, dayIndex) {
            const dayData = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex];
            dayData.isCollapsed = !dayData.isCollapsed;
            renderDetailedItineraryForGroup(groupIndex); 
        }
        function handleEditActivity(groupIndex, dayIndex, activityId) {
            openActivityModal(groupIndex, dayIndex, activityId);
        }
        function handleDuplicateActivity(groupIndex, dayIndex, activityId) {
            const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
            const activityToDuplicate = dayActivities.find(act => act.id === activityId);
            if (activityToDuplicate) {
                const newActivity = { ...activityToDuplicate, id: generateId(), title: `${activityToDuplicate.title} (ë³µì‚¬ë³¸)` };
                const originalIndex = dayActivities.findIndex(act => act.id === activityId);
                dayActivities.splice(originalIndex + 1, 0, newActivity);
                renderDetailedItineraryForGroup(groupIndex);
            }
        }
        function handleDeleteActivity(groupIndex, dayIndex, activityId) {
            if (window.confirm("ì´ í™œë™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
                quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities = dayActivities.filter(act => act.id !== activityId);
                renderDetailedItineraryForGroup(groupIndex);
            }
        }


        function syncAllContentEditablesToTextareas() { /* ... original ... */ }
        function generateHTMLFromDetailedItinerary(quoteGroupIndex) { /* This will need significant update to use quoteGroupDataStore */ return ""; }
        function _getPreviewTemplateHeaderHTML() { /* ... original ... */ }
        function _getPreviewTemplateFooterHTML() { /* ... original ... */ }
        function _generatePreviewBasicInfoHTML_Template(form) { /* ... original ... */ }
        function _generatePreviewTravelerInfoHTML_Template() { /* ... original ... */ }
        function _generatePreviewForSingleQuoteGroupHTML_Template(quoteGroupElement, groupIndex, totalQuoteGroups) { /* ... original ... */ }
        function _generatePreviewPriceSubgroupsHTML_ForQuoteGroup(quoteGroupElement, groupIndex) { /* ... original ... */ }
        function _generatePreviewInclusionsExclusionsHTML_ForQuoteGroup(quoteGroupElement, groupIndex, type) { /* ... original ... */ }
        function _generatePreviewFlightSubgroupsHTML_ForQuoteGroup(quoteGroupElement, groupIndex) { /* ... original ... */ }
        function _generatePreviewItineraryHTML_ForQuoteGroup(quoteGroupElement, groupIndex) { /* ... original ... */ }
        function getMobileStylesForDownload() { /* ... original ... */ }
        function _getQuoteGroupDataFromElement(groupElement) { /* Needs update for detailedItinerary */ return {}; }
        function getAllEditorDataAsObject() { /* Needs update for detailedItinerary */ return {}; }
        function restoreEditorFromData(data) { /* Needs update for detailedItinerary */ }
        function previewQuote() { /* ... original ... */ }
        function downloadGeneratedHTML() { /* ... original ... */ }

    </script>
</body>
</html>
