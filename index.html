<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모바일 견적서_0526_3</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- Added XLSX Library -->
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .custom-orange { color: #000; } /* 사용자 정의 주황색 계열 */
        .bg-custom-orange { background-color: #e1e1e1; color: #000; } /* 사용자 정의 주황색 배경 */
        .border-custom-orange { border-color: #ff5a00; } /* 사용자 정의 주황색 테두리 */
        .custom-green { color: #66bb6a; } /* 사용자 정의 초록색 계열 */
        .bg-custom-green { background-color: #66bb6a; } /* 사용자 정의 초록색 배경 */
        .border-custom-green { border-color: #66bb6a; } /* 사용자 정의 초록색 테두리 */
        @media print { body { width: 100%; margin: 0; padding: 0; } } /* 인쇄 시 설정 */
        .mb-8 { margin-bottom: 1rem; } /* 하단 여백 */
        .w-2\/10 { width: 20%; } /* 너비 20% */
        .w-3\/10 { width: 34%; } /* 너비 34% */
        .w-4\/10 { width: 40%; } /* 너비 40% */

        .quote-group-section { /* 견적 그룹 섹션 스타일 */
            border-width: 2px;
            border-style: solid;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: relative;
            padding-top: 4rem; /* 그룹 액션 버튼 공간 확보 */
            /* border-color는 JS로 설정됩니다 */
        }

        .group-action-buttons { /* 그룹 액션 버튼 컨테이너 */
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }

        .group-action-buttons button { /* 그룹 액션 버튼 스타일 */
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            line-height: 1;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        .copy-quote-group-btn { background-color: #ffc107; color: #212529 !important; } /* 그룹 복사 버튼 */
        .copy-quote-group-btn:hover { background-color: #e0a800; }
        .delete-quote-group-btn { background-color: #dc3545; } /* 그룹 삭제 버튼 */
        .delete-quote-group-btn:hover { background-color: #c82333; }

        .dynamic-section { /* 동적 섹션 (요금 소그룹, 항공 스케줄 소그룹 등) */
            border: 1px dashed #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            background-color: #fdfdfd;
            position: relative;
        }
        .delete-dynamic-section-btn { /* 동적 섹션 삭제 버튼 */
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            line-height: 1;
            z-index: 10;
            color: #ef4444; /* Tailwind red-500 */
        }
        .delete-dynamic-section-btn:hover {
            color: #dc2626; /* Tailwind red-600 */
        }

        [contenteditable][placeholder]:empty:before { /* contenteditable 플레이스홀더 */
            content: attr(placeholder);
            color: #a0aec0; /* Tailwind gray-500 */
            pointer-events: none;
            display: block;
        }

        .group-title-input { /* 견적 그룹 제목 입력 필드 */
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .preview-toggle-icon { /* 미리보기 토글 아이콘 (현재 미사용) */
            margin-left: 10px;
            font-size: 0.9em;
            color: #555;
        }

        /* --- 상세 일정표 UI 스타일 --- */
        .itinerary-planner-styles .action-button-sm { /* 상세 일정표 내 작은 액션 버튼 */
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: white;
        }
        .itinerary-planner-styles .action-button-sm:hover {
            filter: brightness(0.95);
        }
        .itinerary-planner-styles .action-button-sm .fas { /* 상세 일정표 작은 액션 버튼 내 아이콘 */
            width: 14px;
            height: 14px;
            margin-right: 4px;
        }

        .itinerary-planner-styles .day-section { /* 상세 일정표 - 날짜별 섹션 */
            margin-bottom: 16px;
            border: 1px solid #E0E0E0;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        .itinerary-planner-styles .day-header-container { /* 상세 일정표 - 날짜 헤더 컨테이너 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #EEE;
            background-color: #fdfdfd;
            border-radius: 6px 6px 0 0;
        }
        .itinerary-planner-styles .day-header-main { /* 상세 일정표 - 날짜 헤더 주요 내용 (제목, 날짜 수정) */
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
        }
        .itinerary-planner-styles .day-header-title { /* 상세 일정표 - 날짜 헤더 제목 */
            font-size: 18px;
            font-weight: 600;
        }
        .itinerary-planner-styles .date-edit-input { /* 상세 일정표 - 날짜 수정 입력 필드 */
            font-size: 16px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 220px; /* Placeholder에 맞게 조금 더 넓힘 */
        }
        .itinerary-planner-styles .day-header-controls { /* 상세 일정표 - 날짜 헤더 컨트롤 버튼 그룹 */
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .itinerary-planner-styles .icon-button { /* 상세 일정표 - 아이콘 버튼 공통 스타일 */
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        .itinerary-planner-styles .icon-button:hover {
            background-color: #e0e0e0;
        }
        .itinerary-planner-styles .icon-button .fas { /* 상세 일정표 - 아이콘 버튼 내 아이콘 */
            font-size: 1rem;
        }
         .itinerary-planner-styles .icon-button.delete-detailed-day-button .fas { /* 상세일정의 날짜 삭제 버튼 아이콘 색상 */
            color: #ef4444; /* Tailwind red-500 */
        }
        .itinerary-planner-styles .icon-button.delete-detailed-day-button:hover .fas {
            color: #dc2626; /* Tailwind red-600 */
        }
        .itinerary-planner-styles .day-content-wrapper { /* 상세 일정표 - 날짜 내용 래퍼 */
            padding: 0 8px 8px 8px;
        }
        .itinerary-planner-styles .activity-card { /* 상세 일정표 - 활동 카드 */
            background-color: white;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
        }
        .itinerary-planner-styles .activities-list .activity-card:first-child { /* 상세 일정표 - 첫번째 활동 카드 상단 여백 제거 */
            margin-top: 8px;
        }
        .itinerary-planner-styles .card-time-icon-area { /* 상세 일정표 - 활동 카드 시간/아이콘 영역 */
            width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .itinerary-planner-styles .card-icon { /* 상세 일정표 - 활동 카드 아이콘 */
            font-size: 24px;
            margin-bottom: 4px;
        }
        .itinerary-planner-styles .card-time { /* 상세 일정표 - 활동 카드 시간 */
            font-size: 14px;
            font-weight: bold;
            min-height: 21px;
        }
        .itinerary-planner-styles .card-details-area { /* 상세 일정표 - 활동 카드 상세 내용 영역 */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .itinerary-planner-styles .card-title { /* 상세 일정표 - 활동 카드 제목 */
            font-size: 16px;
            font-weight: bold;
        }
        .itinerary-planner-styles .card-description, /* 상세 일정표 - 활동 카드 설명 */
        .itinerary-planner-styles .card-location, /* 상세 일정표 - 활동 카드 위치 */
        .itinerary-planner-styles .card-cost, /* 상세 일정표 - 활동 카드 비용 */
        .itinerary-planner-styles .card-notes { /* 상세 일정표 - 활동 카드 노트 */
            font-size: 14px;
            color: #374151; /* Tailwind gray-700 */
        }
        .itinerary-planner-styles .card-image { /* 상세 일정표 - 활동 카드 이미지 */
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 8px;
        }
        .itinerary-planner-styles .card-location a { /* 상세 일정표 - 활동 카드 위치 링크 */
            color: #007bff;
            text-decoration: none;
        }
        .itinerary-planner-styles .card-location a:hover {
            text-decoration: underline;
        }
         .itinerary-planner-styles .card-actions-direct { /* 상세 일정표 - 활동 카드 직접 액션 버튼 (수정, 복제, 삭제) */
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 0.25rem; 
            margin-left: auto; 
            padding-left: 0.5rem;
        }
        .itinerary-planner-styles .card-actions-direct .icon-button .fas { /* 상세 일정표 - 활동 카드 직접 액션 아이콘 크기 */
            font-size: 0.875rem; 
        }
        /* Modal Styles */
        .modal-backdrop { /* 모달 배경 */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none; 
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { /* 모달 내용 */
            background-color: white; padding: 24px; border-radius: 8px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-content label { display: block; margin-bottom: 4px; font-weight: 500; }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; margin-bottom: 12px; background-color: white; height: 40px;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
        #toast { /* 토스트 메시지 */
            position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white;
            padding: 10px 20px; border-radius: 5px; z-index: 1050; opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #toast.show { opacity: 1; }

        .action-button {
            padding: 8px 12px;
            font-size: 0.875rem; /* 14px */
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* 아이콘과 텍스트 간격 */
            background-color: #14B8A6; /* Tailwind CSS v2의 teal-500 색상 */
            color: white; /* 글자 및 아이콘 색상 */
            border: none; /* 버튼 기본 테두리 제거 */
        }

        .action-button:hover {
            background-color: #0D9488; /* Tailwind CSS v2의 teal-600 색상 */
            filter: brightness(0.95); 
        }
        /* --- 상세 일정표 미리보기/저장용 스타일 및 인쇄 스타일 삭제됨 --- */

    </style>
</head>
<body class="bg-white p-4">
    <div class="container mx-auto bg-white p-6 shadow-lg rounded-lg" style="max-width: 950px;">
        <header class="mb-6 border-b pb-4 border-gray-200">
            <h1 class="text-3xl font-bold text-center custom-orange">내일투어 여행견적서</h1>
        </header>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">기본 정보</h2>
            <div class="bg-gray-50 p-4 rounded">
                <div class="flex flex-wrap gap-4">
                    <div class="w-full sm:w-2/10 mb-4 sm:mb-0">
                        <label class="block text-gray-700 mb-1 text-sm">고객명(받는이)</label>
                        <input type="text" id="customerName" name="custname" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                    <div class="w-full sm:w-4/10 mb-4 sm:mb-0">
                        <label class="block text-gray-700 mb-1 text-sm">이메일</label>
                        <input type="email" id="customerEmail" name="custmail" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                    <div class="w-full sm:w-3/10">
                        <label class="block text-gray-700 mb-1 text-sm">참조</label>
                        <input type="text" id="custcmail" name="custcmail" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-1 text-sm">메일제목</label>
                    <input type="text" id="subject" name="subject" value="[내일투어]  고객님, 행복한 여행을 위한 견적 안내 메일입니다." class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-2 text-sm">안내사항 (본문 첫 부분)</label>
                    <textarea id="introText" name="intro" rows="4" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="안녕하세요! 내일투어입니다. 고객님의 소중한 여행을 함께 준비하겠습니다."></textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-1 text-sm">상품명 (공통)</label>
                    <input type="text" id="goodnm" name="goodnm" value="" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">예약자 정보</h2>
            <div class="bg-gray-50 p-4 rounded">
                <textarea id="travelerInfoText" name="traveler_info_text" rows="3" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="예 : 1 HAN/WONHEE MR 2. LEE/SONGYI MS"></textarea>
            </div>
        </section>

        <div id="quoteGroupsContainer" class="mb-8">
            </div>

        <div class="text-center mb-8 py-4 border-t border-b border-gray-200">
            <button type="button" id="addGlobalQuoteGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                <i class="fas fa-plus mr-2"></i>새 견적 그룹 추가
            </button>
        </div>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">담당자 정보</h2>
            <div class="bg-gray-50 p-4 rounded">
                <div class="flex flex-wrap gap-4">
                    <div class="w-full sm:w-2/10 mb-4 sm:mb-0"><label class="block text-gray-700 mb-1 text-sm">담당자</label><input type="text" id="empnm" name="empnm" value="임창순" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                    <div class="w-full sm:w-4/10 mb-4 sm:mb-0"><label class="block text-gray-700 mb-1 text-sm">담당자메일</label><input type="email" id="empmail" name="empmail" value="fire@naeiltour.co.kr" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                    <div class="w-full sm:w-3/10"><label class="block text-gray-700 mb-1 text-sm">연락처</label><input type="text" id="emptel" name="emptel" value="02-6262-5301" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                </div>
            </div>
        </section>

        <footer class="mt-8 text-center text-gray-500 text-sm border-t pt-4">
            <button type="button" onclick="previewQuote();" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #e1e1e1;font-weight: 700;color: #000;">미리보기</button>
            <button type="button" onclick="downloadGeneratedHTML();" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #28a745;font-weight: 700;color: #fff; margin-left: 5px;">HTML 파일로 저장</button>
            <input type="file" id="loadQuoteFile" accept=".html" style="display: none;">
            <button type="button" onclick="document.getElementById('loadQuoteFile').click();" style="padding: 5px 10px; font-size: 13px; cursor: pointer; border: 1px solid #ccc; background: #f0ad4e; font-weight: 700; color: #fff; margin-left: 5px;">견적 불러오기 (HTML)</button>
        </footer>
    </div>

    <div id="activityModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">새 일정 추가</h2>
            <form id="activityForm">
                <input type="hidden" id="currentQuoteGroupIndex">
                <input type="hidden" id="currentDayIndex">
                <input type="hidden" id="currentActivityId">
                <div>
                    <label for="activityTimeInput">시간 (HHMM 형식, 선택 사항):</label>
                    <input type="text" id="activityTimeInput" placeholder="예: 1130 또는 0900" maxlength="4">
                </div>
                <div>
                    <label for="activityIconSelect">아이콘 선택:</label>
                    <select id="activityIconSelect"> </select>
                </div>
                <div>
                    <label for="activityTitle">활동/장소명:</label>
                    <input type="text" id="activityTitle" required placeholder="예: 루브르 박물관 방문">
                </div>
                <div>
                    <label for="activityDescription">간단 설명/메모:</label>
                    <textarea id="activityDescription" rows="3" placeholder="예: 모나리자 및 주요 작품 관람"></textarea>
                </div>
                <div>
                    <label for="activityLocation">주소/위치 링크:</label>
                    <input type="url" id="activityLocation" placeholder="예: https://maps.google.com/... (선택 사항)">
                </div>
                <div>
                    <label for="activityImageUrl">이미지 URL:</label>
                    <input type="url" id="activityImageUrl" placeholder="예: https://example.com/image.jpg (선택 사항)">
                </div>
                <div>
                    <label for="activityCost">비용:</label>
                    <input type="text" id="activityCost" placeholder="예: €20 또는 ₩25,000 (선택 사항)">
                </div>
                <div>
                    <label for="activityNotes">기타 필드 (예약번호 등):</label>
                    <input type="text" id="activityNotes" placeholder="예: 예약번호: 12345 (선택 사항)">
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancelActivityModalButton" class="action-button-sm bg-gray-300 hover:bg-gray-400 text-gray-800">취소</button>
                    <button type="submit" id="saveActivityModalButton" class="action-button-sm bg-green-500 text-white hover:bg-green-600">저장</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast"></div> 
    
    <!-- Global hidden file inputs for detailed itinerary features -->
    <input type="file" id="detailedItineraryHtmlLoadInput_main" accept=".html" style="display: none;">
    <input type="file" id="detailedItineraryExcelLoadInput_main" accept=".xlsx, .csv" style="display: none;">
    <input type="file" id="detailedDayHtmlLoadInput_main" accept=".html" style="display: none;">

    <script>
        // ----- 전역 변수 및 초기화 함수 -----
        let quoteGroupCounter = 0; // 견적 그룹 카운터
        let quoteGroupDataStore = {}; // 견적 그룹 데이터 저장소

        // 여행 관련 이모지 목록
        const travelEmojis = [
            { value: "", display: "아이콘 없음" }, { value: "✈️", display: "✈️ 항공" }, { value: "🏨", display: "🏨 숙소" },
            { value: "🍽️", display: "🍽️ 식사" }, { value: "🏛️", display: "🏛️ 관광(실내)" }, { value: "🏞️", display: "🏞️ 관광(야외)" },
            { value: "🚶", display: "🚶 이동(도보)" }, { value: "🚌", display: "🚌 이동(버스)" }, { value: "🚆", display: "🚆 이동(기차)" },
            { value: "🚢", display: "🚢 이동(배)" }, { value: "🚕", display: "🚕 이동(택시)" }, { value: "🛍️", display: "🛍️ 쇼핑" },
            { value: "📷", display: "📷 사진촬영" }, { value: "🗺️", display: "🗺️ 계획/지도" }, { value: "📌", display: "📌 중요장소" },
            { value: "☕", display: "☕ 카페/휴식" }, { value: "🎭", display: "🎭 공연/문화" }, { value: "💼", display: "💼 업무" },
            { value: "ℹ️", display: "ℹ️ 정보" }
        ];
        
        // Global context for file loading
        let currentGroupIndexForLoad = null;
        let currentDayIndexForLoad = null;


        // ----- 유틸리티 함수 -----
        function generateId() { return 'id_' + Math.random().toString(36).substr(2, 9); } // 고유 ID 생성
        function formatDateForDisplay(dateString, dayNumber) { // 날짜 표시 형식 (예: DAY 1: 2025년 5월 26일 월요일)
            try {
                // 입력된 dateString이 유효한 'YYYY-MM-DD' 형식인지 먼저 확인
                if (!isValidYyyyMmDd(String(dateString))) {
                    console.warn(`[formatDateForDisplay] Invalid YYYY-MM-DD format for DAY ${dayNumber}: '${dateString}'`);
                    return `DAY ${dayNumber}: 날짜 형식 오류 (값: ${dateString})`;
                }

                const parts = String(dateString).split('-');
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // JavaScript의 월은 0부터 시작합니다.
                const day = parseInt(parts[2], 10);

                // 년, 월, 일 구성요소를 사용하여 Date 객체 생성
                const date = new Date(year, month, day);

                // 생성된 Date 객체가 유효한지, 그리고 의도한 날짜와 일치하는지 다시 한번 확인
                if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) {
                    console.warn(`[formatDateForDisplay] Date object construction failed or resulted in a different date for DAY ${dayNumber}. Input: '${dateString}', Constructed: ${date}`);
                    return `DAY ${dayNumber}: 날짜 변환 오류 (값: ${dateString})`;
                }

                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                return `DAY ${dayNumber}: ${date.toLocaleDateString('ko-KR', options)}`;
            } catch (e) {
                console.error(`[formatDateForDisplay] Error formatting date for DAY ${dayNumber}, dateString: '${dateString}'`, e);
                return `DAY ${dayNumber}: 날짜 처리 중 예외 발생`;
            }
        }
        function formatTimeToHHMM(timeStr) { // 시간 형식 (HHMM -> HH:MM)
            if (timeStr && timeStr.length === 4 && /^\d{4}$/.test(timeStr)) {
                const hours = timeStr.substring(0, 2);
                const minutes = timeStr.substring(2, 4);
                if (parseInt(hours, 10) >= 0 && parseInt(hours, 10) <= 23 &&
                    parseInt(minutes, 10) >= 0 && parseInt(minutes, 10) <= 59) {
                    return `${hours}:${minutes}`;
                }
            }
            return ""; // 유효하지 않으면 빈 문자열 반환
        }
        function dateToYyyyMmDd(date) { // Date 객체를 YYYY-MM-DD 형식 문자열로 변환
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let dayVal = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (dayVal.length < 2) dayVal = '0' + dayVal;
            return [year, month, dayVal].join('-');
        }
        function showToast(message, duration = 3000, isError = false) { // 토스트 메시지 표시
            const toastElement = document.getElementById('toast');
            if (toastElement) {
                toastElement.textContent = message;
                toastElement.style.backgroundColor = isError ? '#dc3545' : '#333'; // Red for error, dark gray for normal
                toastElement.classList.add('show');
                setTimeout(() => {
                    toastElement.classList.remove('show');
                }, duration);
            }
        }

        // ----- 견적 그룹 생성 및 관리 -----
        const quoteGroupBorderColors = ['#4A90E2', '#50E3C2', '#F5A623', '#BD10E0', '#7ED321', '#D0021B', '#417505', '#9013FE']; // 견적 그룹 테두리 색상 목록
        let currentBorderColorIndex = 0; // 현재 테두리 색상 인덱스

        function createQuoteGroup(groupIndex, afterElement = null, sourceGroupData = null) {
            const groupId = `quoteGroup_${groupIndex}`;
            const quoteGroupDiv = document.createElement('div');
            quoteGroupDiv.className = 'quote-group-section';
            quoteGroupDiv.id = groupId;
            quoteGroupDiv.dataset.groupIndex = groupIndex;

            let borderColorToApply = sourceGroupData?.borderColor || quoteGroupBorderColors[currentBorderColorIndex];
            quoteGroupDiv.style.borderColor = borderColorToApply;
            if (!sourceGroupData?.borderColor) { 
                 currentBorderColorIndex = (currentBorderColorIndex + 1) % quoteGroupBorderColors.length;
            }

            quoteGroupDataStore[groupIndex] = sourceGroupData || {
                groupTitle: "",
                borderColor: borderColorToApply,
                priceSubgroups: [], 
                inclusionExclusion: { includedTextarea: '', excludedTextarea: '' }, 
                flightSubgroups: [], 
                itinerarySummaryRows: [], 
                detailedItinerary: { 
                    title: "여행 일정표", 
                    days: [] 
                }
            };
             if (sourceGroupData && !quoteGroupDataStore[groupIndex].detailedItinerary) { // Ensure detailedItinerary exists
                quoteGroupDataStore[groupIndex].detailedItinerary = { title: "여행 일정표", days: [] };
            }
             if (sourceGroupData && typeof quoteGroupDataStore[groupIndex].detailedItinerary.title === 'undefined') {
                quoteGroupDataStore[groupIndex].detailedItinerary.title = "여행 일정표"; // Default title if missing
            }
             if (sourceGroupData && !sourceGroupData.flightSubgroups) { 
                quoteGroupDataStore[groupIndex].flightSubgroups = [];
            }
             if (sourceGroupData && !sourceGroupData.priceSubgroups) { 
                quoteGroupDataStore[groupIndex].priceSubgroups = [];
            }
            if (sourceGroupData && !sourceGroupData.itinerarySummaryRows) { 
                quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
            }


            quoteGroupDiv.innerHTML = `
                <div class="group-action-buttons">
                    <button type="button" class="copy-quote-group-btn" title="이 견적 그룹 복사"><i class="fas fa-copy mr-1"></i>그룹 복사</button>
                    <button type="button" class="delete-quote-group-btn" title="이 견적 그룹 삭제"><i class="fas fa-trash-alt mr-1"></i>그룹 삭제</button>
                </div>
                <input type="text" name="quote_group_title[${groupIndex}]" class="group-title-input" placeholder="견적 그룹 제목 (예: 1. 대한항공 + 신라 모노그램 다낭 슈페리어)" value="${quoteGroupDataStore[groupIndex].groupTitle}">
                
                <section class="mb-8 price-section-wrapper">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold bg-custom-orange p-2 rounded" style="flex-grow: 1;">요금 안내</h3>
                        <button type="button" class="add-price-subgroup-button bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-xs ml-2" data-group-index="${groupIndex}">
                            <i class="fas fa-plus mr-1"></i> 요금 소그룹 추가
                        </button>
                    </div>
                    <div id="priceSectionsContainer_${groupIndex}" class="price-sections-container-for-group"></div>
                </section>

                <section class="mb-8 inclusion-exclusion-section-wrapper">
                    <h3 class="text-lg font-semibold mb-4 bg-custom-orange p-2 rounded">포함/불포함 사항</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="text-md font-medium mb-2">포함</h4>
                            <textarea name="included_items_textarea[${groupIndex}]" rows="5" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="* 유류할증료, 제세공과금 포함...">${quoteGroupDataStore[groupIndex].inclusionExclusion.includedTextarea}</textarea>
                        </div>
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="text-md font-medium mb-2">불포함</h4>
                            <textarea name="excluded_items_textarea[${groupIndex}]" rows="5" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="● 현지 개인 경비...">${quoteGroupDataStore[groupIndex].inclusionExclusion.excludedTextarea}</textarea>
                        </div>
                    </div>
                </section>

                <section class="mb-8 flight-schedule-section-wrapper">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold bg-custom-orange p-2 rounded" style="flex-grow: 1;">항공 스케줄</h3>
                        <button type="button" class="add-flight-subgroup-button bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-xs ml-2" data-group-index="${groupIndex}">
                            <i class="fas fa-plus mr-1"></i> 항공 스케줄 소그룹 추가
                        </button>
                    </div>
                    <div id="flightScheduleGroupsContainer_${groupIndex}" class="flight-schedule-groups-container-for-group"></div>
                </section>

                <section class="mb-8 itinerary-summary-section-wrapper">
                    <h3 class="text-lg font-semibold mb-4 bg-custom-orange p-2 rounded">간단일정</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border text-sm">
                            <thead><tr class="bg-gray-100">
                                <th class="border p-2 text-left text-xs" style="width: 8%;">일수</th><th class="border p-2 text-left text-xs">날짜</th>
                                <th class="border p-2 text-left text-xs">출발지</th><th class="border p-2 text-left text-xs">도착지</th>
                                <th class="border p-2 text-left text-xs">숙박</th><th class="border p-2 text-left text-xs">이동</th>
                                <th class="border p-2 text-left text-xs">비고</th><th class="border p-2 text-center w-12 text-xs">삭제</th></tr></thead>
                            <tbody id="itineraryTableBody_${groupIndex}" class="itinerary-table-body-for-group"></tbody>
                            <tfoot><tr><td colspan="8" class="border p-2"><button type="button" class="add-itinerary-row-to-group bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs" data-group-index="${groupIndex}"><i class="fas fa-plus mr-1"></i> 행 추가</button></td></tr></tfoot>
                        </table>
                    </div>
                </section>

                <section class="mb-8 itinerary-detail-section-wrapper">
                    <div class="flex justify-between items-center mb-2 bg-custom-orange p-2 rounded-t-md">
                        <h3 class="text-lg font-semibold">상품일정 상세 (일정표)</h3>
                        <div class="itinerary-planner-styles flex items-center space-x-1">
                             <!-- 삭제: 미리보기 버튼 -->
                             <!-- 삭제: HTML 저장 버튼 -->
                             <button type="button" class="action-button-sm load-detailed-itinerary-html-btn" style="background-color: #FACC15;" title="HTML 파일에서 이 그룹 일정 불러오기" data-group-index="${groupIndex}"><i class="fas fa-upload"></i><span class="hidden sm:inline">HTML 불러오기</span></button>
                             <button type="button" class="action-button-sm load-detailed-itinerary-excel-btn" style="background-color: #22C55E;" title="엑셀 파일에서 이 그룹 일정 불러오기" data-group-index="${groupIndex}"><i class="fas fa-file-excel"></i><span class="hidden sm:inline">엑셀 불러오기</span></button>
                        </div>
                    </div>
                    <div id="detailedItineraryContainer_${groupIndex}" class="itinerary-planner-styles p-4 border border-t-0 border-gray-200 rounded-b-md bg-gray-100" style="min-height: 150px;">
                        <input type="text" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm mb-2" name="detailed_itinerary_title[${groupIndex}]" placeholder="상세 일정표 제목 (예: 즐거운 다낭 3박 5일)" value="${quoteGroupDataStore[groupIndex].detailedItinerary.title || '여행 일정표'}">
                        <div id="daysContainerStatic_${groupIndex}"></div> 
                        <div class="add-day-button-container mt-4 text-center">
                             <button type="button" class="add-detailed-itinerary-day-button action-button-sm bg-indigo-500 text-white hover:bg-indigo-600" data-group-index="${groupIndex}">
                                <i class="fas fa-plus"></i> 새 날짜 추가
                            </button>
                        </div>
                    </div>
                </section>
            `;

            const quoteGroupsContainer = document.getElementById('quoteGroupsContainer');
            if (afterElement && afterElement.parentNode === quoteGroupsContainer) {
                quoteGroupsContainer.insertBefore(quoteGroupDiv, afterElement.nextSibling);
            } else {
                quoteGroupsContainer.appendChild(quoteGroupDiv);
            }
            
            initPriceSectionForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].priceSubgroups);
            initFlightScheduleForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].flightSubgroups);
            initInclusionExclusionForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex]); 
            initItinerarySummaryForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].itinerarySummaryRows);
            renderDetailedItineraryForGroup(groupIndex); 

            return quoteGroupDiv;
        }

        // ----- 상세 일정표 관련 함수들 -----
        function renderDetailedItineraryForGroup(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex];

            // 디버깅: groupData와 detailedItinerary 객체, days 배열 상태 확인
            if (!groupData) {
                console.error(`Group data not found for groupIndex: ${groupIndex}`);
                return;
            }
            if (!groupData.detailedItinerary) {
                console.error(`Detailed itinerary object not found for groupIndex: ${groupIndex}`);
                // 안전장치: detailedItinerary 객체가 없다면 생성
                groupData.detailedItinerary = { title: "여행 일정표", days: [] };
                console.log(`Initialized missing detailedItinerary for group ${groupIndex}`);
            }
            if (!Array.isArray(groupData.detailedItinerary.days)) {
                console.error(`detailedItinerary.days is not an array for groupIndex: ${groupIndex}. Value:`, groupData.detailedItinerary.days);
                // 안전장치: days가 배열이 아니면 빈 배열로 초기화
                groupData.detailedItinerary.days = [];
                console.log(`Initialized missing or invalid detailedItinerary.days to [] for group ${groupIndex}`);
            }

            console.log(`[Render Group ${groupIndex}] Days array:`, JSON.parse(JSON.stringify(groupData.detailedItinerary.days))); // 데이터 확인

            if (!groupData || !groupData.detailedItinerary) {
                console.error(`Detailed itinerary data not found for group ${groupIndex}`);
                return;
            }
            const container = document.getElementById(`detailedItineraryContainer_${groupIndex}`);
            if (!container) {
                console.error(`Detailed itinerary container not found for group ${groupIndex}`);
                return;
            }

            let daysHost = container.querySelector(`#daysContainerStatic_${groupIndex}`);
            if (!daysHost) { 
                daysHost = document.createElement('div');
                daysHost.id = `daysContainerStatic_${groupIndex}`;
                const addDayButtonContainer = container.querySelector('.add-day-button-container');
                if (addDayButtonContainer) {
                    container.insertBefore(daysHost, addDayButtonContainer);
                } else {
                    container.appendChild(daysHost);
                }
            }
            daysHost.innerHTML = ''; 

            // days 배열의 각 요소가 유효한지, date 속성이 있는지 확인
            groupData.detailedItinerary.days.forEach((day, dayIdx) => {
                if (!day || typeof day.date === 'undefined') { // day 객체 또는 day.date가 undefined인 경우
                    console.warn(`[Render Group ${groupIndex}] Day object at index ${dayIdx} is invalid or missing date. Skipping. Day data:`, day);
                    // 이 경우, 기본 날짜를 생성하거나, 이 day를 건너뛰도록 할 수 있습니다.
                    // 임시로 오늘 날짜로 설정하여 렌더링 시도 (실제 데이터는 수정하지 않음)
                    const tempDate = dateToYyyyMmDd(new Date()); // 임시 오늘 날짜
                    console.warn(`[Render Group ${groupIndex}] Using temporary date '${tempDate}' for rendering invalid day at index ${dayIdx}.`)
                    // day.date = tempDate; // 실제 데이터를 변경하지 않으려면 이 줄은 주석 처리하고 아래 formatDateForDisplay에 tempDate를 직접 전달

                    // 화면 표시를 위해 임시 날짜 사용
                    const daySection = document.createElement('div');
                    daySection.className = 'day-section';
                    daySection.dataset.dayIndex = dayIdx;
                    daySection.innerHTML = `<div class="p-2 text-red-500">DAY ${dayIdx + 1}: 저장된 날짜 정보 오류. 날짜를 수정해주세요. (임시 표시: ${formatDateForDisplay(tempDate, dayIdx+1)}) </div>`;
                    daysHost.appendChild(daySection);
                    return; // 이 day 렌더링 중단하고 다음 day로
                }

                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                daySection.dataset.dayIndex = dayIdx;

                let dateDisplayHTML;
                if (day.editingDate) { 
                    dateDisplayHTML = `
                        <input type="text" class="date-edit-input itinerary-planner-styles" value="${day.date}" placeholder="YYYY-MM-DD 또는 YYYYMMDD">
                        <button class="icon-button save-detailed-date-button itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}" title="날짜 저장"><i class="fas fa-save"></i></button>
                        <button class="icon-button cancel-detailed-date-edit-button itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}" title="취소"><i class="fas fa-times"></i></button>
                    `;
                } else { 
                    // console.log(`[Render Group ${groupIndex}] Formatting display for day ${dayIdx + 1}, date from store: '${day.date}'`);
                    dateDisplayHTML = `
                        <h2 class="day-header-title">${formatDateForDisplay(day.date, dayIdx + 1)}</h2>
                        <button class="icon-button edit-detailed-date-button ml-2 itinerary-planner-styles" title="날짜 수정" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    `;
                }

                // ... (이하 HTML 생성 및 appendChild 로직은 동일)
                daySection.innerHTML = `
                    <div class="day-header-container">
                        <div class="day-header-main">
                            ${dateDisplayHTML}
                        </div>
                        <div class="day-header-controls">
                            <!-- 삭제: 이 날짜 HTML로 저장 버튼 -->
                            <!-- <button class="icon-button save-detailed-day-html-button itinerary-planner-styles" title="이 날짜 HTML로 저장" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-paperclip"></i></button> -->
                            <button class="icon-button load-detailed-day-html-button itinerary-planner-styles" title="이 날짜에 HTML 덮어쓰기" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-clipboard"></i></button>
                            <button class="icon-button delete-detailed-day-button itinerary-planner-styles" title="이 날짜 전체 삭제" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-trash-alt"></i></button>
                            <button class="icon-button toggle-detailed-day-collapse-button itinerary-planner-styles" title="펼치기/접기" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                                <i class="fas ${day.isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="day-content-wrapper ${day.isCollapsed ? 'hidden' : ''}">
                        <div class="activities-list activities-list-group-${groupIndex}-day-${dayIdx} pt-3" data-group-index="${groupIndex}" data-day-index="${dayIdx}" style="min-height: 20px;">
                        </div>
                        <button class="add-activity-to-day-button mt-3 mb-2 action-button" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> 이 날짜에 새 일정 추가
                        </button>
                    </div>
                `;
                daysHost.appendChild(daySection);
                renderDetailedActivitiesForDayInGroup(groupIndex, dayIdx); 
            });
        }

        function renderDetailedActivitiesForDayInGroup(groupIndex, dayIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            const day = groupData.detailedItinerary.days[dayIndex];
            const activitiesListContainer = document.querySelector(`.activities-list-group-${groupIndex}-day-${dayIndex}`);

            if (!day || !activitiesListContainer) {
                console.error(`Day data or activities container not found for group ${groupIndex}, day ${dayIndex}`);
                return;
            }
            activitiesListContainer.innerHTML = ''; 

            day.activities.forEach(activity => {
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.dataset.activityId = activity.id;
                let imageHTML = '';
                if (activity.imageUrl) { imageHTML = `<img src="${activity.imageUrl}" alt="${activity.title || '활동 이미지'}" class="card-image" onerror="this.style.display='none';">`; }

                card.innerHTML = `
                    <div class="card-time-icon-area">
                        <div class="card-icon">${activity.icon || ''}</div>
                        <div class="card-time">${formatTimeToHHMM(activity.time)}</div>
                    </div>
                    <div class="card-details-area">
                        <div class="card-title">${activity.title || ''}</div>
                        ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''}
                        ${imageHTML}
                        ${activity.locationLink ? `<div class="card-location">📍 <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">위치 보기</a></div>` : ''}
                        ${activity.cost ? `<div class="card-cost">💰 ${activity.cost}</div>` : ''}
                        ${activity.notes ? `<div class="card-notes">📝 ${activity.notes}</div>` : ''}
                    </div>
                    <div class="card-actions-direct">
                        <button class="icon-button edit-activity-button itinerary-planner-styles" title="수정" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="icon-button duplicate-activity-button itinerary-planner-styles" title="복제" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-copy"></i></button>
                        <button class="icon-button delete-activity-button itinerary-planner-styles" title="삭제" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                activitiesListContainer.appendChild(card);
            });
        }

        function handleAddDetailedItineraryDay(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            if (!groupData || !groupData.detailedItinerary) {
                console.error(`Cannot add day: detailedItinerary data is missing for group ${groupIndex}`);
                return;
            }

            let newDate;
            const daysArray = groupData.detailedItinerary.days;

            if (daysArray.length > 0) {
                const lastDayObject = daysArray[daysArray.length - 1];
                if (lastDayObject && lastDayObject.date && isValidYyyyMmDd(lastDayObject.date)) {
                    const lastDateStr = lastDayObject.date;
                    const parts = lastDateStr.split('-');
                    const year = parseInt(parts[0], 10);
                    const monthVal = parseInt(parts[1], 10) - 1; // JS month is 0-indexed
                    const dayVal = parseInt(parts[2], 10);
                    const lastDate = new Date(year, monthVal, dayVal);

                    if (isNaN(lastDate.getTime())) { // Safety check if Date construction failed
                        console.warn(`[handleAddDetailedItineraryDay] lastDate parsed as invalid from '${lastDayObject.date}'. Defaulting to today.`);
                        newDate = new Date();
                    } else {
                        newDate = new Date(lastDate);
                        newDate.setDate(lastDate.getDate() + 1);
                    }
                } else {
                    console.warn(`[handleAddDetailedItineraryDay] Last day's date in group ${groupIndex} is invalid or missing ('${lastDayObject?.date}'). Defaulting to today for the new day.`);
                    newDate = new Date();
                }
            } else {
                newDate = new Date();
            }

            let newDayDateString = dateToYyyyMmDd(newDate);
            
            // Final fallback if newDayDateString is somehow still NaN-NaN-NaN
            if (newDayDateString === "NaN-NaN-NaN") {
                console.error(`[handleAddDetailedItineraryDay] CRITICAL: Calculated newDayDateString resulted in 'NaN-NaN-NaN'. Forcing to today's date.`);
                newDayDateString = dateToYyyyMmDd(new Date());
            }
            
            console.log(`Adding new day for group ${groupIndex}: ${newDayDateString}`);

            if (daysArray.length > 0) { 
                const lastDayObject = daysArray[daysArray.length - 1];
                // 마지막 날짜가 유효한 YYYY-MM-DD 형식인지 먼저 확인
                if (lastDayObject && lastDayObject.date && isValidYyyyMmDd(lastDayObject.date)) {
                    const lastDate = new Date(lastDayObject.date.replace(/-/g, '/') + "T00:00:00");
                    newDate = new Date(lastDate);
                    newDate.setDate(lastDate.getDate() + 1);
                } else {
                    // 마지막 날짜가 유효하지 않거나 없으면 오늘 날짜 기준으로 설정
                    console.warn(`Last day's date in group ${groupIndex} is invalid or missing ('${lastDayObject?.date}'). Defaulting to today for the new day.`);
                    newDate = new Date();
                }
            } else { 
                newDate = new Date(); 
            }

            daysArray.push({
                date: newDayDateString,
                activities: [],
                isCollapsed: false, 
                editingDate: false
            });
            renderDetailedItineraryForGroup(groupIndex); 
        }

        // ----- Activity Modal -----
        const activityModal = document.getElementById('activityModal');
        const activityForm = document.getElementById('activityForm');
        const modalTitle = document.getElementById('modalTitle');
        const activityIconSelect = document.getElementById('activityIconSelect');
        const currentQuoteGroupIndexInput = document.getElementById('currentQuoteGroupIndex');
        const currentDayIndexInput = document.getElementById('currentDayIndex');
        const currentActivityIdInput = document.getElementById('currentActivityId');

        function populateIconDropdown() { 
            activityIconSelect.innerHTML = '';
            travelEmojis.forEach(emoji => {
                const option = document.createElement('option');
                option.value = emoji.value;
                option.textContent = emoji.display;
                activityIconSelect.appendChild(option);
            });
        }

        function openActivityModal(groupIndex, dayIndex, activityId = null) { 
            currentQuoteGroupIndexInput.value = groupIndex;
            currentDayIndexInput.value = dayIndex;
            activityForm.reset(); 
            populateIconDropdown(); 

            if (activityId) { 
                modalTitle.textContent = '일정 수정';
                currentActivityIdInput.value = activityId;
                const activity = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities.find(act => act.id === activityId);
                if (activity) { 
                    document.getElementById('activityTimeInput').value = activity.time || "";
                    activityIconSelect.value = activity.icon || "";
                    document.getElementById('activityTitle').value = activity.title || "";
                    document.getElementById('activityDescription').value = activity.description || "";
                    document.getElementById('activityLocation').value = activity.locationLink || "";
                    document.getElementById('activityImageUrl').value = activity.imageUrl || "";
                    document.getElementById('activityCost').value = activity.cost || "";
                    document.getElementById('activityNotes').value = activity.notes || "";
                }
            } else { 
                modalTitle.textContent = '새 일정 추가';
                currentActivityIdInput.value = '';
                activityIconSelect.value = travelEmojis[0].value; 
            }
            activityModal.style.display = 'flex'; 
        }

        function closeActivityModal() { 
            activityModal.style.display = 'none';
        }

        document.getElementById('cancelActivityModalButton').addEventListener('click', closeActivityModal); 

        activityForm.addEventListener('submit', function(event) { 
            event.preventDefault();
            const groupIndex = currentQuoteGroupIndexInput.value;
            const dayIndex = parseInt(currentDayIndexInput.value);
            const activityId = currentActivityIdInput.value;

            const timeValue = document.getElementById('activityTimeInput').value.trim();
            if (timeValue && (timeValue.length !== 4 || !/^\d{4}$/.test(timeValue))) { 
                showToast("시간은 HHMM 형식의 4자리 숫자로 입력하거나 비워두세요.", 3000, true);
                return;
            }
            if (timeValue.length === 4) {
                const hours = parseInt(timeValue.substring(0, 2), 10);
                const minutes = parseInt(timeValue.substring(2, 4), 10);
                if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    showToast("유효하지 않은 시간입니다. HH는 00-23, MM은 00-59 사이로 입력해주세요.", 3000, true);
                    return;
                }
            }

            const activityData = {
                id: activityId || generateId(), 
                time: timeValue,
                icon: activityIconSelect.value,
                title: document.getElementById('activityTitle').value,
                description: document.getElementById('activityDescription').value,
                locationLink: document.getElementById('activityLocation').value,
                imageUrl: document.getElementById('activityImageUrl').value,
                cost: document.getElementById('activityCost').value,
                notes: document.getElementById('activityNotes').value,
            };

            const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
            if (activityId) { 
                const activityIndex = dayActivities.findIndex(act => act.id === activityId);
                if (activityIndex > -1) {
                    dayActivities[activityIndex] = activityData;
                }
            } else { 
                dayActivities.push(activityData);
            }
            renderDetailedItineraryForGroup(groupIndex); 
            closeActivityModal(); 
        });


        // ----- 초기화 및 이벤트 리스너 -----
        document.addEventListener('DOMContentLoaded', function() {
            enableSelectOnFocus('div.container'); 
            createQuoteGroup(quoteGroupCounter++); 
            populateIconDropdown(); 

            document.getElementById('addGlobalQuoteGroupBtn').addEventListener('click', function() {
                const newGroupElement = createQuoteGroup(quoteGroupCounter++);
                if (newGroupElement) { 
                    newGroupElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const titleInputToFocus = newGroupElement.querySelector('input[name^="quote_group_title"]');
                    if (titleInputToFocus) setTimeout(() => titleInputToFocus.focus(), 300);
                }
            });

            document.getElementById('quoteGroupsContainer').addEventListener('click', function(e) {
                const target = e.target;
                const quoteGroupElement = target.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                // 상세 일정 관련 이벤트 핸들러
                if (target.closest('.add-detailed-itinerary-day-button')) {
                    handleAddDetailedItineraryDay(groupIndex);
                } else if (target.closest('.add-activity-to-day-button')) {
                    const dayIndex = target.closest('.add-activity-to-day-button').dataset.dayIndex;
                    openActivityModal(groupIndex, parseInt(dayIndex));
                } else if (target.closest('.edit-detailed-date-button')) {
                    const dayIndex = parseInt(target.closest('.edit-detailed-date-button').dataset.dayIndex);
                    handleEditDayDate(groupIndex, dayIndex);
                } else if (target.closest('.save-detailed-date-button')) {
                    const dayIndex = parseInt(target.closest('.save-detailed-date-button').dataset.dayIndex);
                    handleSaveDayDate(groupIndex, dayIndex);
                } else if (target.closest('.cancel-detailed-date-edit-button')) {
                    const dayIndex = parseInt(target.closest('.cancel-detailed-date-edit-button').dataset.dayIndex);
                    handleCancelEditDayDate(groupIndex, dayIndex);
                } else if (target.closest('.delete-detailed-day-button')) {
                    const dayIndex = parseInt(target.closest('.delete-detailed-day-button').dataset.dayIndex);
                    handleDeleteDetailedItineraryDay(groupIndex, dayIndex);
                } else if (target.closest('.toggle-detailed-day-collapse-button')) {
                    const dayIndex = parseInt(target.closest('.toggle-detailed-day-collapse-button').dataset.dayIndex);
                    handleToggleDayCollapse(groupIndex, dayIndex);
                } else if (target.closest('.edit-activity-button')) {
                    const dayIndex = parseInt(target.closest('.edit-activity-button').dataset.dayIndex);
                    const activityId = target.closest('.edit-activity-button').dataset.activityId;
                    openActivityModal(groupIndex, dayIndex, activityId);
                } else if (target.closest('.duplicate-activity-button')) {
                    const dayIndex = parseInt(target.closest('.duplicate-activity-button').dataset.dayIndex);
                    const activityId = target.closest('.duplicate-activity-button').dataset.activityId;
                    handleDuplicateActivity(groupIndex, dayIndex, activityId);
                } else if (target.closest('.delete-activity-button')) {
                    const dayIndex = parseInt(target.closest('.delete-activity-button').dataset.dayIndex);
                    const activityId = target.closest('.delete-activity-button').dataset.activityId;
                    handleDeleteActivity(groupIndex, dayIndex, activityId);
                }
                // Detailed Itinerary Action Buttons (Preview and Save HTML buttons removed)
                // else if (target.closest('.preview-detailed-itinerary-btn')) { /* ... removed ... */ }
                // else if (target.closest('.save-detailed-itinerary-html-btn')) { /* ... removed ... */ } 
                else if (target.closest('.load-detailed-itinerary-html-btn')) { // Kept
                    currentGroupIndexForLoad = groupIndex;
                    document.getElementById('detailedItineraryHtmlLoadInput_main').click();
                } else if (target.closest('.load-detailed-itinerary-excel-btn')) { // Kept
                    currentGroupIndexForLoad = groupIndex;
                    document.getElementById('detailedItineraryExcelLoadInput_main').click();
                } 
                // else if (target.closest('.save-detailed-day-html-button')) { /* ... removed ... */ }
                else if (target.closest('.load-detailed-day-html-button')) { // Kept
                    const dayIndex = parseInt(target.closest('.load-detailed-day-html-button').dataset.dayIndex);
                    currentGroupIndexForLoad = groupIndex;
                    currentDayIndexForLoad = dayIndex;
                    document.getElementById('detailedDayHtmlLoadInput_main').click();
                }


                // 기존 견적 그룹 기능들
                const priceSubgroupElement = target.closest('.price-subgroup');
                if (target.closest('.delete-quote-group-btn')) { 
                    if (window.confirm('이 견적 그룹 전체를 삭제하시겠습니까?')) { 
                        delete quoteGroupDataStore[groupIndex]; 
                        quoteGroupElement.remove();
                    }
                } else if (target.closest('.copy-quote-group-btn')) { 
                    showToast('그룹 복사 기능은 현재 개발 중입니다.');
                } else if (target.closest('.delete-dynamic-section-btn')) { 
                    const dynamicSection = target.closest('.dynamic-section');
                    if (dynamicSection) {
                        const subGroupIndex = dynamicSection.dataset.subGroupIndex;
                        if (dynamicSection.classList.contains('price-subgroup')) { 
                            quoteGroupDataStore[groupIndex].priceSubgroups.splice(subGroupIndex, 1);
                        } else if (dynamicSection.classList.contains('flight-schedule-subgroup')) { 
                            quoteGroupDataStore[groupIndex].flightSubgroups.splice(subGroupIndex, 1);
                        }
                        dynamicSection.remove();
                        if (priceSubgroupElement) { 
                            const parentPriceSubgroup = dynamicSection.closest('.price-subgroup');
                            if(parentPriceSubgroup) updateGrandTotalForSubgroup(parentPriceSubgroup); 
                        }
                    }
                } else if (target.closest('.delete-row')) { 
                    const row = target.closest('tr');
                    const tableBody = row.parentElement;
                    const subGroupElement = target.closest('.dynamic-section'); 
                    if(row && subGroupElement){ 
                        const groupIdx = subGroupElement.dataset.groupIndex; // Renamed to avoid conflict
                        const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                        const rowIndex = Array.from(tableBody.children).indexOf(row);

                        if(subGroupElement.classList.contains('price-subgroup')){
                            quoteGroupDataStore[groupIdx].priceSubgroups[subGroupIndex].rows.splice(rowIndex, 1);
                            updateGrandTotalForSubgroup(subGroupElement); 
                        } else if (subGroupElement.classList.contains('flight-schedule-subgroup')){
                             quoteGroupDataStore[groupIdx].flightSubgroups[subGroupIndex].rows.splice(rowIndex, 1);
                        }
                        row.remove();
                    } else if (row && tableBody.id.startsWith('itineraryTableBody_')) { 
                        const groupIdx = target.closest('.quote-group-section').dataset.groupIndex; // Renamed
                        const rowIndex = Array.from(tableBody.children).indexOf(row);
                        quoteGroupDataStore[groupIdx].itinerarySummaryRows.splice(rowIndex, 1);
                        row.remove();
                    }
                } else if (target.closest('.add-price-subgroup-button')) {
                } else if (target.closest('.add-flight-subgroup-button')) { 
                } else if (target.closest('.add-itinerary-row-to-group')) { 
                    const itineraryTbody = quoteGroupElement.querySelector(`#itineraryTableBody_${groupIndex}`);
                    const newRowData = { dayNo: "", dayDate: "", sCity: "", eCity: "", hotel: "", traffic: "", bigo: "" };
                    if (!quoteGroupDataStore[groupIndex].itinerarySummaryRows) {
                        quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
                    }
                    quoteGroupDataStore[groupIndex].itinerarySummaryRows.push(newRowData);
                    addItineraryRowForGroupUI(itineraryTbody, groupIndex, newRowData.dayNo, newRowData.dayDate, newRowData.sCity, newRowData.eCity, newRowData.hotel, newRowData.traffic, newRowData.bigo);
                }
            });

             document.getElementById('quoteGroupsContainer').addEventListener('input', function(e) {
                const target = e.target;
                const quoteGroupElement = target.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                if (target.matches('input[name^="quote_group_title"]')) { 
                    quoteGroupDataStore[groupIndex].groupTitle = target.value;
                } else if (target.matches('textarea[name^="included_items_textarea"]')) { 
                    quoteGroupDataStore[groupIndex].inclusionExclusion.includedTextarea = target.value;
                } else if (target.matches('textarea[name^="excluded_items_textarea"]')) { 
                    quoteGroupDataStore[groupIndex].inclusionExclusion.excludedTextarea = target.value;
                } else if (target.matches('input[name^="price_subgroup_title"]')) { 
                    const subGroupIndex = target.closest('.price-subgroup').dataset.subGroupIndex;
                    quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].title = target.value;
                } else if (target.matches('input[name^="flight_group_title"]')) { 
                    const subGroupIndex = target.closest('.flight-schedule-subgroup').dataset.subGroupIndex;
                    quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].title = target.value;
                } else if (target.classList.contains('flight-schedule-input')) { 
                    const subGroupElement = target.closest('.flight-schedule-subgroup');
                    const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                    const rowElement = target.closest('tr');
                    const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                    const field = target.dataset.field;
                    if(quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex] && quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows[rowIndex]){
                        quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows[rowIndex][field] = target.value;
                    }
                } else if (target.classList.contains('itinerary-schedule-input')) { 
                    const rowElement = target.closest('tr');
                    const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                    const field = target.dataset.field; 
                    if (quoteGroupDataStore[groupIndex].itinerarySummaryRows[rowIndex]) {
                         quoteGroupDataStore[groupIndex].itinerarySummaryRows[rowIndex][field] = target.value;
                    }
                } else if (target.matches('input[name^="detailed_itinerary_title"]')) { // NEW: Save detailed itinerary title
                    if (quoteGroupDataStore[groupIndex] && quoteGroupDataStore[groupIndex].detailedItinerary) {
                        quoteGroupDataStore[groupIndex].detailedItinerary.title = target.value;
                    }
                }


                if (target.matches('.price-per-person, .person-count')) { 
                    const subgroupElement = target.closest('.price-subgroup');
                    if (subgroupElement) updateRowTotalForSubgroup(e, subgroupElement);
                }
            });

             document.getElementById('quoteGroupsContainer').addEventListener('paste', function(e) {
                const targetInput = e.target;
                const quoteGroupElement = targetInput.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                if (targetInput.matches('.flight-schedule-input')) { 
                    const flightSubgroupElement = targetInput.closest('.flight-schedule-subgroup');
                    if (flightSubgroupElement) {
                        const subGroupIndex = flightSubgroupElement.dataset.subGroupIndex;
                        handlePasteToFlightTableForSubgroup(e, groupIndex, subGroupIndex);
                    }
                } else if (targetInput.matches('.itinerary-schedule-input')) { 
                    const itineraryTableBody = targetInput.closest('tbody.itinerary-table-body-for-group');
                    if (itineraryTableBody) {
                        handlePasteToItineraryTableForGroup(e, itineraryTableBody, groupIndex);
                    }
                }
            });

            const loadQuoteFileInput = document.getElementById('loadQuoteFile');
            if (loadQuoteFileInput) {
                loadQuoteFileInput.addEventListener('change', function(event) {
                    showToast('견적 불러오기 기능은 현재 개발 중입니다.');
                    event.target.value = null; 
                });
            }

            // File input change listeners for detailed itinerary
            document.getElementById('detailedItineraryHtmlLoadInput_main').addEventListener('change', function(event) {
                if (currentGroupIndexForLoad === null) return;
                const file = event.target.files[0];
                if (file) {
                    handleLoadDetailedItineraryFromHtml(currentGroupIndexForLoad, file);
                }
                this.value = null; 
                currentGroupIndexForLoad = null;
            });

            document.getElementById('detailedItineraryExcelLoadInput_main').addEventListener('change', function(event) {
                if (currentGroupIndexForLoad === null) return;
                const file = event.target.files[0];
                if (file) {
                    handleLoadDetailedItineraryFromExcel(currentGroupIndexForLoad, file);
                }
                this.value = null;
                currentGroupIndexForLoad = null;
            });

            document.getElementById('detailedDayHtmlLoadInput_main').addEventListener('change', function(event) {
                if (currentGroupIndexForLoad === null || currentDayIndexForLoad === null) return;
                const file = event.target.files[0];
                if (file) {
                    handleLoadDetailedDayFromHtml(currentGroupIndexForLoad, currentDayIndexForLoad, file);
                }
                this.value = null; 
                currentGroupIndexForLoad = null;
                currentDayIndexForLoad = null;
            });
        });
        
        function enableSelectOnFocus(containerSelector = 'body') { 
            const container = document.querySelector(containerSelector);
            if (!container) return;
            container.addEventListener('focusin', function(event) {
                const target = event.target;
                if (target.matches('input[type="text"], input[type="email"], input[type="number"], textarea')) {
                    if (typeof target.select === 'function' && !target.isContentEditable) { 
                        setTimeout(() => { target.select(); }, 0); 
                    }
                }
            });
        }

        // ----- 요금 섹션 관련 함수들 (기존과 동일) -----
        function initPriceSectionForGroup(quoteGroupElement, groupIndex, sourcePriceSubgroups = null) {
            const addPriceSubgroupButton = quoteGroupElement.querySelector('.add-price-subgroup-button');
            const priceSectionsContainer = quoteGroupElement.querySelector(`#priceSectionsContainer_${groupIndex}`);
            if (!quoteGroupDataStore[groupIndex].priceSubgroups) { quoteGroupDataStore[groupIndex].priceSubgroups = []; }
            let currentSubgroups = quoteGroupDataStore[groupIndex].priceSubgroups;
            if (addPriceSubgroupButton) {
                 addPriceSubgroupButton.addEventListener('click', () => {
                    const newSubgroupData = {title: "", rows: [ { title: "성인요금", perPrice: "0", number: 1, bigo: "" }, { title: "소아요금", perPrice: "0", number: 0, bigo: "2~12세미만(좌석점유)" }, { title: "유아요금", perPrice: "0", number: 0, bigo: "24개월미만(좌석미점유)" } ]};
                    currentSubgroups.push(newSubgroupData); 
                    createPriceSubgroup(priceSectionsContainer, groupIndex, currentSubgroups.length - 1, newSubgroupData); 
                });
            }
            if (currentSubgroups.length > 0) { currentSubgroups.forEach((subgroupData, idx) => createPriceSubgroup(priceSectionsContainer, groupIndex, idx, subgroupData)); } 
            else { const defaultSubgroupData = {title: "", rows: [ { title: "성인요금", perPrice: "0", number: 1, bigo: "" }, { title: "소아요금", perPrice: "0", number: 0, bigo: "2~12세미만(좌석점유)" }, { title: "유아요금", perPrice: "0", number: 0, bigo: "24개월미만(좌석미점유)" } ]}; currentSubgroups.push(defaultSubgroupData); createPriceSubgroup(priceSectionsContainer, groupIndex, 0, defaultSubgroupData); }
        }
        function createPriceSubgroup(container, groupIndex, subGroupIndex, sourceSubgroupData = null) {
            const sectionId = `priceSection_${groupIndex}_${subGroupIndex}`;
            const tableBodyId = `priceTableBody_${groupIndex}_${subGroupIndex}`;
            const grandTotalId = `grandTotal_${groupIndex}_${subGroupIndex}`;
            const groupTitleInputName = `price_subgroup_title[${groupIndex}][${subGroupIndex}]`;
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'dynamic-section price-subgroup'; sectionDiv.id = sectionId; sectionDiv.dataset.groupIndex = groupIndex; sectionDiv.dataset.subGroupIndex = subGroupIndex;
            const initialSubgroupTitle = sourceSubgroupData ? sourceSubgroupData.title : "";
            sectionDiv.innerHTML = `<button type="button" class="delete-dynamic-section delete-dynamic-section-btn text-red-500 hover:text-red-700" title="이 요금 소그룹 삭제"><i class="fas fa-trash-alt mr-1"></i>삭제</button><div class="mb-2"><input type="text" name="${groupTitleInputName}" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-md font-semibold" placeholder="견적설명 (예: 인천출발, 김해출발, A객실, B객실)" value="${initialSubgroupTitle}"></div><div class="overflow-x-auto"><table class="min-w-full bg-white border price-table text-sm"><thead><tr class="bg-gray-100"><th class="border p-2 text-center" style="width: 20%;">내역</th><th class="border p-2 text-center" style="width: 15%;">1인당 금액</th><th class="border p-2 text-center" style="width: 8%;">인원</th><th class="border p-2 text-center" style="width: 17%;">총 금액</th><th class="border p-2 text-center">비고</th><th class="border p-2 text-center w-12">삭제</th></tr></thead><tbody id="${tableBodyId}" class="price-table-body"></tbody><tfoot><tr><td colspan="3" class="border p-2 text-right font-bold text-xs">총 합계</td><td class="border p-1 font-bold"><input type="text" name="p_sumprice[${groupIndex}][${subGroupIndex}]" id="${grandTotalId}" class="w-full border-0 focus:ring-0 grand-total-input text-xs p-1" value="0" readonly></td><td colspan="2" class="border p-2"><button type="button" class="add-price-row-to-subgroup bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs"><i class="fas fa-plus mr-1"></i> 행 추가</button></td></tr></tfoot></table></div>`;
            container.appendChild(sectionDiv); const tbody = sectionDiv.querySelector('.price-table-body');
            const rowsToRender = (sourceSubgroupData && sourceSubgroupData.rows && sourceSubgroupData.rows.length > 0) ? sourceSubgroupData.rows : [ { title: "성인요금", perPrice: "0", number: 1, bigo: "" }, { title: "소아요금", perPrice: "0", number: 0, bigo: "2~12세미만(좌석점유)" }, { title: "유아요금", perPrice: "0", number: 0, bigo: "24개월미만(좌석미점유)" } ];
            rowsToRender.forEach(rowData => addPriceRowToExistingSubgroup(null, sectionDiv, rowData)); initPriceTableForSubgroup(sectionDiv); return sectionDiv;
        }
        function initPriceTableForSubgroup(subgroupElement) { subgroupElement.querySelectorAll('.price-table-body tr').forEach(row => { const firstInput = row.querySelector('.price-per-person'); if (firstInput) updateRowTotalForSubgroup({ target: firstInput }, subgroupElement); }); const addRowButton = subgroupElement.querySelector('.add-price-row-to-subgroup'); if (addRowButton) addRowButton.addEventListener('click', (e) => addPriceRowToExistingSubgroup(e, subgroupElement)); }
        function updateRowTotalForSubgroup(event, subgroupElement) { const row = event.target.closest('tr'); if (!row) return; const pricePerPersonInput = row.querySelector('.price-per-person'); const personCountInput = row.querySelector('.person-count'); const totalPriceInput = row.querySelector('.total-price'); if (!pricePerPersonInput || !personCountInput || !totalPriceInput) return; const pricePerPerson = parseFloat(pricePerPersonInput.value) || 0; const personCount = parseInt(personCountInput.value) || 0; totalPriceInput.value = (pricePerPerson * personCount).toLocaleString(); updateGrandTotalForSubgroup(subgroupElement); }
        function updateGrandTotalForSubgroup(subgroupElement) { let grandTotal = 0; subgroupElement.querySelectorAll('.price-table-body .total-price').forEach(cell => grandTotal += parseFloat(cell.value.replace(/,/g, '')) || 0); const grandTotalInput = subgroupElement.querySelector('.grand-total-input'); if (grandTotalInput) grandTotalInput.value = grandTotal.toLocaleString(); }
        function addPriceRowToExistingSubgroup(event, subgroupElement, rowData = null) { const tbody = subgroupElement.querySelector('.price-table-body'); const groupIndex = subgroupElement.dataset.groupIndex; const subGroupIndex = subgroupElement.dataset.subGroupIndex; if (!tbody || groupIndex === undefined || subGroupIndex === undefined) return; const titleVal = rowData ? rowData.title : "추가 비용"; const perPriceVal = rowData ? rowData.perPrice : "0"; const numberVal = rowData ? rowData.number : "1"; const bigoVal = rowData ? rowData.bigo : ""; const tr = document.createElement('tr'); tr.innerHTML = `<td class="border p-1"><input type="text" name="p_title[${groupIndex}][${subGroupIndex}][]" value="${titleVal}" class="w-full border-0 focus:ring-0"></td><td class="border p-1"><input type="number" name="p_perprice[${groupIndex}][${subGroupIndex}][]" class="price-per-person w-full border-0 focus:ring-0" value="${perPriceVal}"></td><td class="border p-1"><input type="number" name="p_number[${groupIndex}][${subGroupIndex}][]" class="person-count w-full border-0 focus:ring-0" value="${numberVal}"></td><td class="border p-1"><input type="text" name="p_totalprice[${groupIndex}][${subGroupIndex}][]" class="w-full border-0 focus:ring-0 total-price" value="0" readonly></td><td class="border p-1"><input type="text" name="p_bigo[${groupIndex}][${subGroupIndex}][]" class="w-full border-0 focus:ring-0" value="${bigoVal}"></td><td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700" title="삭제"><i class="fas fa-trash"></i></button></td>`; tbody.appendChild(tr); const firstInput = tr.querySelector('.price-per-person'); if (firstInput) updateRowTotalForSubgroup({ target: firstInput }, subgroupElement); if (event) { if (!quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows) { quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows = []; } quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows.push({ title: titleVal, perPrice: perPriceVal, number: numberVal, bigo: bigoVal }); } }

        // ----- 항공 스케줄 섹션 관련 함수들 (기존과 동일) -----
        function initFlightScheduleForGroup(quoteGroupElement, groupIndex, sourceFlightSubgroups = null) {
            const addFlightSubgroupButton = quoteGroupElement.querySelector('.add-flight-subgroup-button'); const flightScheduleContainer = quoteGroupElement.querySelector(`#flightScheduleGroupsContainer_${groupIndex}`);
            if (!quoteGroupDataStore[groupIndex].flightSubgroups) { quoteGroupDataStore[groupIndex].flightSubgroups = []; } let currentSubgroups = quoteGroupDataStore[groupIndex].flightSubgroups;
            if (addFlightSubgroupButton) { addFlightSubgroupButton.addEventListener('click', () => { const newSubgroupData = { title: "", rows: [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }] }; currentSubgroups.push(newSubgroupData); createFlightSubgroup(flightScheduleContainer, groupIndex, currentSubgroups.length - 1, newSubgroupData); }); }
            if (currentSubgroups.length > 0) { currentSubgroups.forEach((subgroupData, idx) => createFlightSubgroup(flightScheduleContainer, groupIndex, idx, subgroupData)); }
            else { const defaultSubgroupData = { title: "", rows: [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }] }; currentSubgroups.push(defaultSubgroupData); createFlightSubgroup(flightScheduleContainer, groupIndex, 0, defaultSubgroupData); }
        }
        function createFlightSubgroup(container, groupIndex, subGroupIndex, sourceSubgroupData = null) {
            const groupId = `flightScheduleGroup_${groupIndex}_${subGroupIndex}`; const tableBodyId = `flightTableBody_${groupIndex}_${subGroupIndex}`; const groupTitleInputName = `flight_group_title[${groupIndex}][${subGroupIndex}]`; const groupDiv = document.createElement('div'); groupDiv.className = 'dynamic-section flight-schedule-subgroup'; groupDiv.id = groupId; groupDiv.dataset.groupIndex = groupIndex; groupDiv.dataset.subGroupIndex = subGroupIndex;
            const initialTitle = sourceSubgroupData ? sourceSubgroupData.title : ""; groupDiv.innerHTML = `<button type="button" class="delete-dynamic-section delete-dynamic-section-btn text-red-500 hover:text-red-700" title="이 항공 스케줄 소그룹 삭제"><i class="fas fa-trash-alt mr-1"></i>삭제</button><div class="mb-2"><input type="text" name="${groupTitleInputName}" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-md font-semibold" placeholder="항공사 (예: 이스타항공)" value="${initialTitle}"></div><div class="overflow-x-auto"><table class="min-w-full bg-white border text-sm"><thead><tr class="bg-gray-100"><th class="border p-2 text-left text-xs">편명</th><th class="border p-2 text-left text-xs">출발일</th><th class="border p-2 text-left text-xs">출발지</th><th class="border p-2 text-left text-xs">출발시간</th><th class="border p-2 text-left text-xs">도착일</th><th class="border p-2 text-left text-xs">도착지</th><th class="border p-2 text-left text-xs">도착시간</th><th class="border p-2 text-center w-12 text-xs">삭제</th></tr></thead><tbody id="${tableBodyId}" class="flight-table-body-subgroup"></tbody><tfoot><tr><td colspan="8" class="border p-2"><button type="button" class="add-flight-row-to-subgroup bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs"><i class="fas fa-plus mr-1"></i> 행 추가</button></td></tr></tfoot></table></div>`;
            container.appendChild(groupDiv); const tbody = groupDiv.querySelector(`#${tableBodyId}`);
            const rowsToRender = (sourceSubgroupData && sourceSubgroupData.rows && sourceSubgroupData.rows.length > 0) ? sourceSubgroupData.rows : [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }];
            rowsToRender.forEach(rowData => { addFlightRowForSubgroup(tbody, groupIndex, subGroupIndex, rowData.flightNum, rowData.depDate, rowData.originCity, rowData.depTime, rowData.arrDate, rowData.destCity, rowData.arrTime); });
            const addFlightRowButton = groupDiv.querySelector('.add-flight-row-to-subgroup'); if(addFlightRowButton) { addFlightRowButton.addEventListener('click', () => { const targetTbody = groupDiv.querySelector('tbody.flight-table-body-subgroup'); if (targetTbody) { const newRowData = { flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }; quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows.push(newRowData); addFlightRowForSubgroup(targetTbody, groupIndex, subGroupIndex); } }); }
            groupDiv.addEventListener('paste', (e) => handlePasteToFlightTableForSubgroup(e, groupIndex, subGroupIndex)); return groupDiv;
        }
        function addFlightRowForSubgroup(tbodyElement, groupIndex, subGroupIndex, flightNum = "", depDate = "", originCity = "", depTime = "", arrDate = "", destCity = "", arrTime = "") {
            if (!tbodyElement) return null; const tr = document.createElement('tr'); tr.innerHTML = `<td class="border p-1"><input type="text" name="dep_trans_flight_group[${groupIndex}][${subGroupIndex}][]" data-field="flightNum" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${flightNum}" placeholder="ZE 561"></td><td class="border p-1"><input type="text" name="start_day_group[${groupIndex}][${subGroupIndex}][]" data-field="depDate" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${depDate}" placeholder="07월 09일"></td><td class="border p-1"><input type="text" name="dep_start_city_cd_group[${groupIndex}][${subGroupIndex}][]" data-field="originCity" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${originCity}" placeholder="인천"></td><td class="border p-1"><input type="text" name="dep_start_time_group[${groupIndex}][${subGroupIndex}][]" data-field="depTime" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${depTime}" placeholder="20:55"></td><td class="border p-1"><input type="text" name="arrival_day_group[${groupIndex}][${subGroupIndex}][]" data-field="arrDate" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${arrDate}" placeholder="07월 09일"></td><td class="border p-1"><input type="text" name="dep_end_city_cd_group[${groupIndex}][${subGroupIndex}][]" data-field="destCity" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${destCity}" placeholder="나트랑"></td><td class="border p-1"><input type="text" name="dep_end_time_group[${groupIndex}][${subGroupIndex}][]" data-field="arrTime" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${arrTime}" placeholder="23:55"></td><td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="삭제"><i class="fas fa-trash"></i></button></td>`;
            tbodyElement.appendChild(tr); return tr;
        }
        
        // ----- 포함/불포함 사항 섹션 초기화 함수 (기존과 동일) -----
        function initInclusionExclusionForGroup(quoteGroupElement, groupIndex, sourceData = null) { /* ... 기존 로직 ... */ }
        
        // ----- 간단 일정 섹션 관련 함수들 (기존과 동일) -----
        function initItinerarySummaryForGroup(quoteGroupElement, groupIndex, sourceItineraryRows = null) {
            const tbody = quoteGroupElement.querySelector(`#itineraryTableBody_${groupIndex}`); tbody.innerHTML = '';
            if (!quoteGroupDataStore[groupIndex].itinerarySummaryRows) { quoteGroupDataStore[groupIndex].itinerarySummaryRows = []; }
            if (sourceItineraryRows && sourceItineraryRows.length > 0 && quoteGroupDataStore[groupIndex].itinerarySummaryRows.length === 0) { quoteGroupDataStore[groupIndex].itinerarySummaryRows = JSON.parse(JSON.stringify(sourceItineraryRows)); }
            quoteGroupDataStore[groupIndex].itinerarySummaryRows.forEach(rowData => { addItineraryRowForGroupUI(tbody, groupIndex, rowData.dayNo, rowData.dayDate, rowData.sCity, rowData.eCity, rowData.hotel, rowData.traffic, rowData.bigo); });
        }
        function addItineraryRowForGroupUI(tbodyElement, groupIndex, dayNoVal = "", dayDateVal = "", sCityVal = "", eCityVal = "", hotelVal = "", trafficVal = "", bigoVal = "") {
            if (!tbodyElement) { console.error("tbodyElement is null in addItineraryRowForGroupUI for groupIndex:", groupIndex); return null; }
            const tr = document.createElement('tr'); tr.innerHTML = `<td class="border p-1"><input type="text" name="schdule_no[${groupIndex}][]" data-field="dayNo" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${dayNoVal}" placeholder="1"></td><td class="border p-1"><input type="text" name="schdule_day[${groupIndex}][]" data-field="dayDate" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${dayDateVal}" placeholder="12월 28일"></td><td class="border p-1"><input type="text" name="schdule_scity[${groupIndex}][]" data-field="sCity" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${sCityVal}" placeholder="인천"></td><td class="border p-1"><input type="text" name="schdule_ecity[${groupIndex}][]" data-field="eCity" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${eCityVal}" placeholder="푸꾸옥"></td><td class="border p-1"><input type="text" name="schdule_hotel[${groupIndex}][]" data-field="hotel" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${hotelVal}" placeholder="버고호텔"></td><td class="border p-1"><input type="text" name="schdule_traffic[${groupIndex}][]" data-field="traffic" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${trafficVal}" placeholder="항공"></td><td class="border p-1"><input type="text" name="schdule_bigo[${groupIndex}][]" data-field="bigo" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${bigoVal}"></td><td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="삭제"><i class="fas fa-trash"></i></button></td>`;
            tbodyElement.appendChild(tr); return tr;
        }

        // ----- 붙여넣기 핸들러 함수 (기존과 동일) -----
        function handlePasteToFlightTableForSubgroup(event, groupIndex, subGroupIndex) { 
            const targetInput = event.target; if (!targetInput.matches('.flight-schedule-input')) return; event.preventDefault(); 
            const pasteData = (event.clipboardData || window.clipboardData).getData('text/plain'); const rowsOfData = pasteData.split(/\r\n|\n|\r/);
            let currentRowElement = targetInput.closest('tr'); let currentCellIndexInRow = Array.from(currentRowElement.cells).indexOf(targetInput.closest('td')); 
            const currentTbody = currentRowElement.closest('tbody.flight-table-body-subgroup'); const flightSubgroupData = quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex];
            rowsOfData.forEach((rowText, pasteRowIndex) => {
                if (!rowText.trim()) return; const cellsOfData = rowText.split('\t'); let currentTbodyRowIndex = Array.from(currentTbody.children).indexOf(currentRowElement);
                if (!currentRowElement) { const newRowData = { flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }; flightSubgroupData.rows.push(newRowData); currentRowElement = addFlightRowForSubgroup(currentTbody, groupIndex, subGroupIndex); if (!currentRowElement) return; currentCellIndexInRow = 0; currentTbodyRowIndex = flightSubgroupData.rows.length -1; }
                const inputFieldsInCurrentRow = currentRowElement.querySelectorAll('.flight-schedule-input'); let dataCellIdx = 0;
                for (let i = currentCellIndexInRow; i < inputFieldsInCurrentRow.length && dataCellIdx < cellsOfData.length; i++) { const fieldName = inputFieldsInCurrentRow[i].dataset.field; const pastedValue = cellsOfData[dataCellIdx].trim(); inputFieldsInCurrentRow[i].value = pastedValue; if (flightSubgroupData.rows[currentTbodyRowIndex]) { flightSubgroupData.rows[currentTbodyRowIndex][fieldName] = pastedValue; } dataCellIdx++; }
                const nextTRElement = currentRowElement.nextElementSibling; currentRowElement = (nextTRElement && nextTRElement.cells.length > 0) ? nextTRElement : null; currentCellIndexInRow = 0;
            });
        }
        function handlePasteToItineraryTableForGroup(event, tbodyElement, groupIndex) { 
            const targetInput = event.target; if (!targetInput.matches('.itinerary-schedule-input')) return; event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text/plain'); const rowsOfData = pasteData.split(/\r\n|\n|\r/);
            let currentRowElement = targetInput.closest('tr'); let currentCellIndexInRow = Array.from(currentRowElement.cells).indexOf(targetInput.closest('td'));
            const summaryRowsData = quoteGroupDataStore[groupIndex].itinerarySummaryRows;
            rowsOfData.forEach((rowText, pasteRowIndex) => {
                if (!rowText.trim()) return; const cellsOfData = rowText.split('\t'); let currentTbodyRowIndex = Array.from(tbodyElement.children).indexOf(currentRowElement);
                if (!currentRowElement) { const newRowData = { dayNo: "", dayDate: "", sCity: "", eCity: "", hotel: "", traffic: "", bigo: "" }; summaryRowsData.push(newRowData); currentRowElement = addItineraryRowForGroupUI(tbodyElement, groupIndex); if (!currentRowElement) return; currentCellIndexInRow = 0; currentTbodyRowIndex = summaryRowsData.length -1; }
                const inputFieldsInCurrentRow = currentRowElement.querySelectorAll('.itinerary-schedule-input'); let dataCellIdx = 0;
                for (let i = currentCellIndexInRow; i < inputFieldsInCurrentRow.length && dataCellIdx < cellsOfData.length; i++) { const fieldName = inputFieldsInCurrentRow[i].dataset.field; const pastedValue = cellsOfData[dataCellIdx].trim(); inputFieldsInCurrentRow[i].value = pastedValue; if (summaryRowsData[currentTbodyRowIndex]) { summaryRowsData[currentTbodyRowIndex][fieldName] = pastedValue; } dataCellIdx++; }
                const nextTRElement = currentRowElement.nextElementSibling; currentRowElement = (nextTRElement && nextTRElement.cells.length > 0) ? nextTRElement : null; currentCellIndexInRow = 0;
            });
        }
        
        // --- 상세 일정 날짜/활동 제어 함수 (기존과 거의 동일, date parsing 강화) ---
        function isValidYyyyMmDd(dateString) { // YYYY-MM-DD 형식 검사
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return false;
            const parts = dateString.split("-");
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10); 
            const day = parseInt(parts[2], 10);
            if (year < 1000 || year > 3000 || month === 0 || month > 12) return false;
            const testDate = new Date(year, month - 1, day);
            return (testDate.getFullYear() === year && testDate.getMonth() === month - 1 && testDate.getDate() === day);
        }
        function parseAndFormatDateInput(inputValue) { 
            let dateStr = String(inputValue).trim().replace(/\./g, '-'); // . 구분자도 -로 변경

            // YYYY-M-D 또는 YYYY-MM-DD 형식 시도
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
                 const parts = dateStr.split('-');
                 const year = parts[0];
                 const month = parts[1].padStart(2,'0');
                 const day = parts[2].padStart(2,'0');
                const formatted = `${year}-${month}-${day}`;
                if (isValidYyyyMmDd(formatted)) return formatted; // 유효성 검사 후 반환
            }

            // YYYYMMDD (8자리) 형식 시도
            if (/^\d{8}$/.test(dateStr)) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const formatted = `${year}-${month}-${day}`;
                if (isValidYyyyMmDd(formatted)) return formatted; // 유효성 검사 후 반환
            }

            // YYMMDD (6자리) 형식 시도 (20YY년으로 가정)
            if (/^\d{6}$/.test(dateStr)) {
                const year = `20${dateStr.substring(0, 2)}`; // "20" + YY
                const month = dateStr.substring(2, 4);
                const day = dateStr.substring(4, 6);
                const formatted = `${year}-${month}-${day}`;
                if (isValidYyyyMmDd(formatted)) return formatted; // 유효성 검사 후 반환
            }
            return null; // 어떤 형식에도 맞지 않거나 유효하지 않으면 null 반환
        }

        function recalculateAllDetailedDates(groupIndex, startingDayIndex) { 
            const daysArray = quoteGroupDataStore[groupIndex].detailedItinerary.days;
            // Ensure startingDayIndex is valid and the day object at that index exists
            if (daysArray.length > startingDayIndex && daysArray[startingDayIndex]) {
                const startDateString = daysArray[startingDayIndex].date;

                // Validate the startDateString before use
                if (!startDateString || !isValidYyyyMmDd(startDateString)) {
                    console.warn(`[recalculateAllDetailedDates] Invalid or missing start date at index ${startingDayIndex}: '${startDateString}'. Aborting recalculation for subsequent dates.`);
                    return; // Prevent propagation of NaN
                }

                // Parse the validated date string carefully
                const parts = startDateString.split('-');
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // JS month is 0-indexed
                const day = parseInt(parts[2], 10);
                let currentDate = new Date(year, month, day);

                // Double check if new Date() failed despite isValidYyyyMmDd (should be extremely rare)
                if (isNaN(currentDate.getTime())) {
                     console.error(`[recalculateAllDetailedDates] Failed to create a valid Date object from '${startDateString}' even after validation. Date was parsed as year:${year}, month:${month}, day:${day}. Aborting.`);
                     return;
                }

                for (let i = startingDayIndex + 1; i < daysArray.length; i++) {
                    if (daysArray[i]) { // Ensure subsequent day object exists
                        currentDate.setDate(currentDate.getDate() + 1);
                        daysArray[i].date = dateToYyyyMmDd(currentDate);
                    }
                }
            }
        }
        function handleEditDayDate(groupIndex, dayIndex) { 
            quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = true;
            renderDetailedItineraryForGroup(groupIndex);
            const inputField = document.querySelector(`#detailedItineraryContainer_${groupIndex} .day-section[data-day-index="${dayIndex}"] .date-edit-input`);
            if (inputField) { inputField.focus(); inputField.select(); }
        }
        function handleSaveDayDate(groupIndex, dayIndex) { 
            const inputField = document.querySelector(`#detailedItineraryContainer_${groupIndex} .day-section[data-day-index="${dayIndex}"] .date-edit-input`);
            if (inputField) {
                const validatedDate = parseAndFormatDateInput(inputField.value);
                if (validatedDate && isValidYyyyMmDd(validatedDate)) { 
                    quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].date = validatedDate;
                    quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = false;
                    recalculateAllDetailedDates(groupIndex, dayIndex); 
                    renderDetailedItineraryForGroup(groupIndex);
                } else {
                    showToast("잘못된 날짜 형식입니다. (YYYY-MM-DD 또는 YYYYMMDD)", 3000, true); 
                }
            }
        }
        function handleCancelEditDayDate(groupIndex, dayIndex) { 
            quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = false;
            renderDetailedItineraryForGroup(groupIndex);
        }
        function handleDeleteDetailedItineraryDay(groupIndex, dayIndex) { 
            if (window.confirm(`DAY ${dayIndex + 1} 일정을 삭제하시겠습니까?`)) {
                quoteGroupDataStore[groupIndex].detailedItinerary.days.splice(dayIndex, 1);
                if (quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0) {
                     if (dayIndex === 0 && quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0) {
                         // No specific recalculation needed if first is deleted and others remain; render will renumber.
                         // However, if other days relied on its date, they might need to be shifted or user re-evaluates.
                         // For now, let's assume the first valid date remaining becomes the new base if needed.
                         // Or better: if a valid date exists at new index 0, recalculate from there.
                         if(isValidYyyyMmDd(quoteGroupDataStore[groupIndex].detailedItinerary.days[0].date)){
                             recalculateAllDetailedDates(groupIndex, 0);
                         }
                    } else if (dayIndex > 0 && isValidYyyyMmDd(quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex -1].date) ) { 
                         recalculateAllDetailedDates(groupIndex, dayIndex -1 );
                    } else if (quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0 && isValidYyyyMmDd(quoteGroupDataStore[groupIndex].detailedItinerary.days[0].date)) {
                        // If a non-first was deleted, or first was deleted and the new first might be invalid from context
                        recalculateAllDetailedDates(groupIndex, 0);
                    }
                }
                renderDetailedItineraryForGroup(groupIndex);
            }
        }
        function handleToggleDayCollapse(groupIndex, dayIndex) { 
            const dayData = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex];
            dayData.isCollapsed = !dayData.isCollapsed;
            renderDetailedItineraryForGroup(groupIndex); 
        }
        function handleEditActivity(groupIndex, dayIndex, activityId) { 
            openActivityModal(groupIndex, dayIndex, activityId);
        }
        function handleDuplicateActivity(groupIndex, dayIndex, activityId) { 
            const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
            const activityToDuplicate = dayActivities.find(act => act.id === activityId);
            if (activityToDuplicate) {
                const newActivity = { ...activityToDuplicate, id: generateId(), title: `${activityToDuplicate.title} (복사본)` };
                const originalIndex = dayActivities.findIndex(act => act.id === activityId);
                dayActivities.splice(originalIndex + 1, 0, newActivity); 
                renderDetailedItineraryForGroup(groupIndex);
            }
        }
        function handleDeleteActivity(groupIndex, dayIndex, activityId) { 
            if (window.confirm("이 활동을 삭제하시겠습니까?")) {
                const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
                quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities = dayActivities.filter(act => act.id !== activityId);
                renderDetailedItineraryForGroup(groupIndex);
            }
        }

        // --- NEW: Detailed Itinerary File Operations ---
        // --- 삭제된 함수들 ---
        // function generateReadOnlyHTMLViewForQuoteGroup(groupIndex, forSingleDay = false, dayIndex = null) { ... }
        // function handlePreviewDetailedItinerary(groupIndex) { ... }
        // function handleSaveDetailedItineraryAsHtml(groupIndex) { ... }
        // function handleSaveDetailedDayAsHtml(groupIndex, dayIndex) { ... }
        
        function handleLoadDetailedItineraryFromHtml(groupIndex, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const htmlString = e.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, "text/html");
                    // MODIFIED ID HERE
                    const embeddedDataElement = doc.getElementById('embeddedTripData'); 
                    if (embeddedDataElement && embeddedDataElement.textContent) { // ID 일치 확인
                        const loadedData = JSON.parse(embeddedDataElement.textContent);
                        // 'loadedData' for 'embeddedTripData' might directly be the itinerary object {title: ..., days: ...}
                        // or it could be nested if the source HTML structure is different.
                        // Assuming 'loadedData' is the itinerary object itself based on the provided example.
                        if (loadedData && Array.isArray(loadedData.days)) { // Basic validation
                            
                            // 날짜 형식 검증 및 변환
                            loadedData.days.forEach(day => {
                                if (day.date) {
                                    const validatedLoadedDate = parseAndFormatDateInput(String(day.date));
                                    if (validatedLoadedDate && isValidYyyyMmDd(validatedLoadedDate)) {
                                        day.date = validatedLoadedDate;
                                    } else {
                                        console.warn(`Loaded HTML contained an invalid date format for a day: '${day.date}'. Defaulting to today.`);
                                        day.date = dateToYyyyMmDd(new Date()); // 유효하지 않으면 오늘 날짜로
                                    }
                                } else {
                                    console.warn("Loaded HTML contained a day object without a date. Setting to today's date.");
                                    day.date = dateToYyyyMmDd(new Date()); // 날짜가 아예 없는 경우 기본값
                                }
                                if (typeof day.isCollapsed === 'undefined') day.isCollapsed = false;
                                if (typeof day.editingDate === 'undefined') day.editingDate = false;
                                day.activities.forEach(act => { if(!act.id) act.id = generateId(); }); // Ensure IDs
                            });

                            // Ensure the main structure has a title.
                            if (typeof loadedData.title === 'undefined') {
                                loadedData.title = "여행 일정표"; // Default title if missing
                            }

                            quoteGroupDataStore[groupIndex].detailedItinerary = loadedData;
                            
                             if (typeof quoteGroupDataStore[groupIndex].detailedItinerary.title === 'undefined') {
                                quoteGroupDataStore[groupIndex].detailedItinerary.title = "여행 일정표";
                            }
                            document.querySelector(`input[name="detailed_itinerary_title[${groupIndex}]"]`).value = quoteGroupDataStore[groupIndex].detailedItinerary.title;
                            renderDetailedItineraryForGroup(groupIndex);
                            showToast('HTML 파일에서 상세 일정을 불러왔습니다.');
                        } else { throw new Error('유효하지 않은 데이터 형식입니다 (days 배열 누락).'); }
                    } else { throw new Error('HTML 파일에서 상세 일정 데이터(ID: embeddedTripData)를 찾을 수 없습니다.'); }
                } catch (err) { console.error("HTML 불러오기 오류:", err); showToast(`오류: ${err.message}`, 3000, true); }
            };
            reader.onerror = () => { showToast('파일을 읽는 중 오류가 발생했습니다.', 3000, true); console.error("File reading error for HTML itinerary."); };
            reader.readAsText(file);
        }

        function handleLoadDetailedItineraryFromExcel(groupIndex, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF:'yyyy-mm-dd'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false, defval: ""});

                    if (jsonData.length < 2) { throw new Error("엑셀 파일에 데이터가 없거나 헤더만 존재합니다."); }

                    const newItinerary = { title: quoteGroupDataStore[groupIndex].detailedItinerary.title || "엑셀에서 가져온 일정", days: [] };
                    let currentDayObject = null;
                    let errors = [];

                    for (let i = 1; i < jsonData.length; i++) { // Skip header row
                        const row = jsonData[i];
                        const excelRowNumber = i + 1;

                        const rawDate = row[0] ? String(row[0]).trim() : "";
                        let time = row[1] ? String(row[1]).trim() : "";
                        if (time.includes(':')) time = time.replace(':', ''); // HH:MM to HHMM
                        if (time.length === 3) time = '0' + time; // HMM to HHMM

                        const title = row[2] ? String(row[2]).trim() : "";
                        const description = row[3] ? String(row[3]).trim() : "";
                        const icon = row[4] ? String(row[4]).trim() : "";
                        const locationLink = row[5] ? String(row[5]).trim() : "";
                        const imageUrl = row[6] ? String(row[6]).trim() : "";
                        const cost = row[7] ? String(row[7]).trim() : "";
                        const notes = row[8] ? String(row[8]).trim() : "";
                        
                        let formattedDate = "";
                        if (!rawDate) { errors.push(`${excelRowNumber}행: 날짜(A열) 누락. 건너<0xEB뛰기>.`); continue; }

                        // Attempt to parse date from Excel (numeric or string YYYY-MM-DD)
                        let parsedDateObj = null;
                        if (typeof row[0] === 'number') { // Excel date serial number
                             parsedDateObj = XLSX.SSF.parse_date_code(row[0]);
                             if(parsedDateObj) formattedDate = `${parsedDateObj.y}-${String(parsedDateObj.m).padStart(2,'0')}-${String(parsedDateObj.d).padStart(2,'0')}`;
                        } else if (typeof rawDate === 'string') {
                            const potentialDate = parseAndFormatDateInput(rawDate);
                            if (potentialDate && isValidYyyyMmDd(potentialDate)) {
                                formattedDate = potentialDate;
                            }
                        }
                        
                        if (!formattedDate || !isValidYyyyMmDd(formattedDate)) { errors.push(`${excelRowNumber}행: 날짜(A열) 형식 오류 ("${rawDate}"). 건너<0xEB뛰기>.`); continue; }
                        if (!title) { errors.push(`${excelRowNumber}행: 활동명(C열) 누락. 건너<0xEB뛰기>.`); continue; }
                        if (time && (!/^\d{4}$/.test(time) || parseInt(time.substring(0,2),10) > 23 || parseInt(time.substring(2,4),10) > 59 )) { errors.push(`${excelRowNumber}행: 시간(B열) 형식 오류 ("${row[1]}"). 시간 정보 없이 진행.`); time = "";}


                        if (!currentDayObject || currentDayObject.date !== formattedDate) {
                            currentDayObject = { date: formattedDate, activities: [], isCollapsed: false, editingDate: false };
                            newItinerary.days.push(currentDayObject);
                        }
                        // Ensure activities have IDs and other defaults if necessary
                        currentDayObject.activities.forEach(act => { 
                            if(!act.id) act.id = generateId(); 
                            // Add other default initializations for activity properties if needed
                        });
                        // Ensure day object has necessary defaults
                        if (typeof currentDayObject.isCollapsed === 'undefined') currentDayObject.isCollapsed = false;
                        if (typeof currentDayObject.editingDate === 'undefined') currentDayObject.editingDate = false;


                        currentDayObject.activities.push({ id: generateId(), time, icon, title, description, locationLink, imageUrl, cost, notes });
                    }
                    
                    if (errors.length > 0) { showToast("엑셀 불러오기 중 일부 오류 발생. 콘솔 확인.", 3000, true); console.warn("엑셀 오류:\n" + errors.join("\n")); }
                    if (newItinerary.days.length > 0) {
                        quoteGroupDataStore[groupIndex].detailedItinerary = newItinerary;
                        // Ensure title exists
                        if (typeof quoteGroupDataStore[groupIndex].detailedItinerary.title === 'undefined') {
                            quoteGroupDataStore[groupIndex].detailedItinerary.title = "엑셀에서 가져온 일정";
                        }
                        // Ensure each day and activity has necessary defaults (double check after loop)
                        quoteGroupDataStore[groupIndex].detailedItinerary.days.forEach(day => { if (typeof day.isCollapsed === 'undefined') day.isCollapsed = false; if (typeof day.editingDate === 'undefined') day.editingDate = false; day.activities.forEach(act => { if(!act.id) act.id = generateId(); }); });

                        document.querySelector(`input[name="detailed_itinerary_title[${groupIndex}]"]`).value = newItinerary.title;
                        renderDetailedItineraryForGroup(groupIndex);
                        showToast('엑셀에서 상세 일정을 성공적으로 불러왔습니다.');
                    } else if (errors.length === 0) {
                        showToast('엑셀 파일에 처리할 유효한 데이터가 없습니다.', 3000, true);
                    }

                } catch (err) { console.error("엑셀 불러오기 오류:", err); showToast(`엑셀 파일 처리 오류: ${err.message}`, 3000, true); }
            };
            reader.onerror = () => { showToast('파일을 읽는 중 오류가 발생했습니다.', 3000, true); console.error("File reading error for Excel itinerary."); };
            reader.readAsArrayBuffer(file);
        }

        function handleLoadDetailedDayFromHtml(groupIndex, dayIndexToOverwrite, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const htmlString = e.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, "text/html");
                    // MODIFIED ID HERE
                    const embeddedDataElement = doc.getElementById('embeddedTripDayData'); 
                    if (embeddedDataElement && embeddedDataElement.textContent) {
                        const loadedDayData = JSON.parse(embeddedDataElement.textContent);
                        if (loadedDayData && loadedDayData.activities !== undefined) { // 날짜 존재 여부는 선택적일 수 있음
                            
                            let finalDate = dateToYyyyMmDd(new Date()); // 기본값: 오늘
                            if (loadedDayData.date) {
                                const validatedLoadedDate = parseAndFormatDateInput(String(loadedDayData.date));
                                if (validatedLoadedDate && isValidYyyyMmDd(validatedLoadedDate)) {
                                    finalDate = validatedLoadedDate;
                                } else {
                                    showToast(`불러온 날짜 형식이 올바르지 않아 (${loadedDayData.date}), 현재 날짜로 설정합니다.`, 4000, true);
                                    // Attempt to use the existing date of the day being overwritten if valid
                                    const existingDay = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite];
                                    if (existingDay && existingDay.date && isValidYyyyMmDd(existingDay.date)) {
                                        finalDate = existingDay.date;
                                        showToast(`덮어쓰는 날짜의 기존 날짜(${finalDate})를 사용합니다.`, 4000);
                                    } else {
                                         finalDate = dateToYyyyMmDd(new Date()); // Fallback to today
                                         showToast(`기존 날짜도 유효하지 않아, 오늘 날짜(${finalDate})로 설정합니다.`, 4000, true);
                                    }
                                }
                            } else {
                                 showToast(`불러온 데이터에 날짜 정보가 없어, 오늘 날짜로 설정합니다.`, 4000, true);
                                 const existingDay = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite];
                                 if (existingDay && existingDay.date && isValidYyyyMmDd(existingDay.date)) {
                                     finalDate = existingDay.date;
                                     showToast(`덮어쓰는 날짜의 기존 날짜(${finalDate})를 사용합니다.`, 4000);
                                 } else {
                                      finalDate = dateToYyyyMmDd(new Date()); // Fallback to today
                                      showToast(`기존 날짜도 유효하지 않아, 오늘 날짜(${finalDate})로 설정합니다.`, 4000, true);
                                 }
                            }
                            loadedDayData.date = finalDate; // 최종 날짜 설정

                            loadedDayData.activities.forEach(act => { if(!act.id) act.id = generateId(); });
                            
                            // Ensure the day being overwritten exists
                            if (!quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite]) {
                                quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite] = {}; // Create if not exists
                            }

                            quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite] = {
                                ...quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite], // Preserve other potential props
                                ...loadedDayData, // date and activities will be overwritten
                                isCollapsed: loadedDayData.isCollapsed !== undefined ? loadedDayData.isCollapsed : false, 
                                editingDate: false // Always reset editing state
                            };
                            recalculateAllDetailedDates(groupIndex, dayIndexToOverwrite); // Recalculate if date changed
                            renderDetailedItineraryForGroup(groupIndex);
                            showToast(`DAY ${dayIndexToOverwrite + 1} 일정을 불러온 내용으로 덮어썼습니다.`);
                        } else { throw new Error('유효하지 않은 날짜 데이터 형식입니다 (activities 누락).'); }
                    } else { throw new Error('HTML 파일에서 날짜 데이터(ID: embeddedTripDayData)를 찾을 수 없습니다.'); }
                } catch (err) { console.error("날짜 HTML 덮어쓰기 오류:", err); showToast(`오류: ${err.message}`, 3000, true); }
            };
            reader.onerror = () => { showToast('파일을 읽는 중 오류가 발생했습니다.', 3000, true); console.error("File reading error for day HTML."); };
            reader.readAsText(file);
        }


        // ----- 기타 함수 (현재 미사용 또는 기존 로직 유지) -----
        function syncAllContentEditablesToTextareas() { /* ... 기존 로직 ... */ }
        // function generateHTMLFromDetailedItinerary(quoteGroupIndex) { /* REPLACED by generateReadOnlyHTMLViewForQuoteGroup */ return ""; }
        function _getPreviewTemplateHeaderHTML() { /* ... 기존 로직 ... */ }
        function _getPreviewTemplateFooterHTML() { /* ... 기존 로직 ... */ }
        function _generatePreviewBasicInfoHTML_Template(form) { /* ... 기존 로직 ... */ }
        function _generatePreviewTravelerInfoHTML_Template() { /* ... 기존 로직 ... */ }
        function _generatePreviewForSingleQuoteGroupHTML_Template(quoteGroupElement, groupIndex, totalQuoteGroups) { /* ... 기존 로직 ... */ }
        function _generatePreviewPriceSubgroupsHTML_ForQuoteGroup(quoteGroupElement, groupIndex) { /* ... 기존 로직 ... */ }
        function _generatePreviewInclusionsExclusionsHTML_ForQuoteGroup(quoteGroupElement, groupIndex, type) { /* ... 기존 로직 ... */ }
        function _generatePreviewFlightSubgroupsHTML_ForQuoteGroup(quoteGroupElement, groupIndex) { /* ... 기존 로직 ... */ }
        function _generatePreviewItineraryHTML_ForQuoteGroup(quoteGroupElement, groupIndex) { /* ... 기존 로직 ... */ }
        function getMobileStylesForDownload() { /* ... 기존 로직 ... */ }
        function _getQuoteGroupDataFromElement(groupElement) { /* 상세 일정 데이터 포함하도록 업데이트 필요 */ return {}; }
        function getAllEditorDataAsObject() { /* 상세 일정 데이터 포함하도록 업데이트 필요 */ return {}; }
        function restoreEditorFromData(data) { /* 상세 일정 데이터 포함하도록 업데이트 필요 */ }
        function previewQuote() { /* ... 기존 로직 ... */ }
        function downloadGeneratedHTML() { /* ... 기존 로직 ... */ }

    </script>
</body>
</html>
